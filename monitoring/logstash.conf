input {
  # File input for MCP server logs
  file {
    path => "/var/log/mcp/*.log"
    start_position => "beginning"
    tags => ["mcp-server-logs"]
    codec => multiline {
      pattern => "^%{TIMESTAMP_ISO8601}"
      negate => true
      what => "previous"
    }
  }

  # Beats input for direct log shipping
  beats {
    port => 5044
    tags => ["beats"]
  }

  # HTTP input for direct log submission
  http {
    port => 8080
    codec => json
    tags => ["http-input"]
  }

  # TCP input for syslog
  tcp {
    port => 5000
    type => "syslog"
    tags => ["syslog"]
  }
}

filter {
  # Process MCP server logs
  if "mcp-server-logs" in [tags] {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{LOGLEVEL:log_level}\] \[%{WORD:server_name}\] %{GREEDYDATA:log_message}"
      }
    }

    # Parse timestamp
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }

    # Add server metadata
    mutate {
      add_field => {
        "service" => "mcp-orchestrator"
        "component" => "mcp-server"
      }
      remove_field => ["timestamp"]
    }

    # Extract error details if present
    if [log_level] == "ERROR" or [log_level] == "FATAL" {
      grok {
        match => {
          "log_message" => "(?<error_type>[A-Za-z]+Error):? %{GREEDYDATA:error_details}"
        }
        tag_on_failure => ["_grok_error_parse_failure"]
      }
    }

    # Parse JSON if message contains JSON
    if [log_message] =~ /^\{.*\}$/ {
      json {
        source => "log_message"
        target => "json_data"
      }
    }
  }

  # Process HTTP input logs
  if "http-input" in [tags] {
    mutate {
      add_field => {
        "service" => "mcp-orchestrator"
        "input_type" => "http"
      }
    }
  }

  # Add GeoIP if IP address is present
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }

  # Normalize log levels
  mutate {
    lowercase => ["log_level"]
  }

  # Add environment tags
  mutate {
    add_field => {
      "environment" => "production"
      "cluster" => "mcp-cluster-1"
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "mcp-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
    template_name => "mcp-logs"
    template => "/usr/share/logstash/templates/mcp-logs-template.json"
    template_overwrite => true
  }

  # Output errors to separate index
  if [log_level] in ["error", "fatal", "critical"] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "mcp-errors-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }

  # Output metrics to separate index
  if [type] == "metric" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "mcp-metrics-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }

  # Debug output (comment out in production)
  # stdout {
  #   codec => rubydebug
  # }
}
