name: Auto-merge Gate

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  pull_request:
    types: [opened, synchronize, reopened, labeled, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: read

jobs:
  ready:
    name: Check Auto-merge Readiness
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: read
    
    # Skip draft PRs
    if: github.event.pull_request.draft == false
    
    outputs:
      auto_merge_ready: ${{ steps.gate.outputs.auto_merge_ready }}
    
    steps:
      - name: Check if PR is draft
        run: |
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "‚è∏Ô∏è PR is still in draft mode"
            exit 1
          fi
          echo "‚úÖ PR is ready for review"

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            console.log(`PR #${pr.number}: ${pr.title}`);
            console.log(`State: ${pr.state}`);
            console.log(`Mergeable: ${pr.mergeable}`);
            console.log(`Mergeable state: ${pr.mergeable_state}`);
            console.log(`Head SHA: ${pr.head.sha}`);
            
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('mergeable', pr.mergeable);
            core.setOutput('mergeable_state', pr.mergeable_state);
            return pr;

      - name: Get check runs for PR head
        id: checks
        uses: actions/github-script@v7
        with:
          script: |
            const head_sha = '${{ steps.pr.outputs.head_sha }}';
            
            // Get check runs for this commit
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: head_sha
            });
            
            console.log(`Found ${checkRuns.check_runs.length} check runs`);
            
            let failing = [];
            let pending = [];
            let success = [];
            let aiReviewFound = false;
            let aiReviewPassed = false;
            
            for (const run of checkRuns.check_runs) {
              console.log(`Check: ${run.name} - Status: ${run.status} - Conclusion: ${run.conclusion}`);
              
              // Track AI Code Review check specifically
              if (run.name === 'AI Code Review') {
                aiReviewFound = true;
                if (run.status === 'completed' && run.conclusion === 'success') {
                  aiReviewPassed = true;
                }
              }
              
              if (run.status !== 'completed') {
                pending.push(run.name);
              } else if (run.conclusion === 'failure' || run.conclusion === 'cancelled' || run.conclusion === 'timed_out') {
                failing.push(run.name);
              } else if (run.conclusion === 'success') {
                success.push(run.name);
              }
            }
            
            core.setOutput('failing_count', failing.length);
            core.setOutput('pending_count', pending.length);
            core.setOutput('success_count', success.length);
            core.setOutput('failing_checks', failing.join(', '));
            core.setOutput('pending_checks', pending.join(', '));
            core.setOutput('ai_review_found', aiReviewFound);
            core.setOutput('ai_review_passed', aiReviewPassed);
            
            return {
              failing,
              pending,
              success,
              aiReviewFound,
              aiReviewPassed
            };

      - name: Get check suites for PR head
        id: suites
        uses: actions/github-script@v7
        with:
          script: |
            const head_sha = '${{ steps.pr.outputs.head_sha }}';
            
            // Get check suites for this commit
            const { data: checkSuites } = await github.rest.checks.listSuitesForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: head_sha
            });
            
            console.log(`Found ${checkSuites.check_suites.length} check suites`);
            
            let allPassed = true;
            for (const suite of checkSuites.check_suites) {
              console.log(`Suite: ${suite.app.name} - Status: ${suite.status} - Conclusion: ${suite.conclusion}`);
              
              if (suite.status === 'completed') {
                if (suite.conclusion !== 'success' && suite.conclusion !== 'neutral' && suite.conclusion !== 'skipped') {
                  allPassed = false;
                }
              }
            }
            
            core.setOutput('all_suites_passed', allPassed);
            return checkSuites;

      - name: Determine auto-merge readiness
        id: gate
        run: |
          FAILING_COUNT="${{ steps.checks.outputs.failing_count }}"
          PENDING_COUNT="${{ steps.checks.outputs.pending_count }}"
          MERGEABLE="${{ steps.pr.outputs.mergeable }}"
          AI_REVIEW_FOUND="${{ steps.checks.outputs.ai_review_found }}"
          AI_REVIEW_PASSED="${{ steps.checks.outputs.ai_review_passed }}"
          
          echo "## Auto-merge Gate Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if there are failing checks
          if [ "$FAILING_COUNT" -gt 0 ]; then
            echo "‚ùå **Status: NOT READY**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** $FAILING_COUNT check(s) failing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Failing checks: ${{ steps.checks.outputs.failing_checks }}" >> $GITHUB_STEP_SUMMARY
            echo "auto_merge_ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check if there are pending checks
          if [ "$PENDING_COUNT" -gt 0 ]; then
            echo "‚è≥ **Status: PENDING**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** $PENDING_COUNT check(s) still running" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Pending checks: ${{ steps.checks.outputs.pending_checks }}" >> $GITHUB_STEP_SUMMARY
            echo "auto_merge_ready=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check mergeable state
          if [ "$MERGEABLE" != "true" ]; then
            echo "‚ùå **Status: NOT READY**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** PR is not mergeable" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Mergeable state: ${{ steps.pr.outputs.mergeable_state }}" >> $GITHUB_STEP_SUMMARY
            echo "auto_merge_ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Optionally check AI Code Review (informational, not blocking by default)
          if [ "$AI_REVIEW_FOUND" == "true" ]; then
            if [ "$AI_REVIEW_PASSED" == "true" ]; then
              echo "‚úÖ AI Code Review: Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è AI Code Review: Not passed (informational)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ÑπÔ∏è AI Code Review: Not configured" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Status: READY FOR AUTO-MERGE**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- All CI checks passed" >> $GITHUB_STEP_SUMMARY
          echo "- PR is mergeable" >> $GITHUB_STEP_SUMMARY
          echo "- Not in draft mode" >> $GITHUB_STEP_SUMMARY
          
          echo "auto_merge_ready=true" >> $GITHUB_OUTPUT

  auto-merge:
    name: Execute Auto-merge
    needs: ready
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    # Only run if PR has auto-merge label AND ready check passed
    if: |
      needs.ready.outputs.auto_merge_ready == 'true' &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check PR status
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m llm_framework.scripts.check_pr_status \
            --pr-number ${{ github.event.pull_request.number }} \
            --repo-owner ${{ github.repository_owner }} \
            --repo-name ${{ github.event.repository.name }}

      - name: Auto-merge PR
        if: steps.check.outputs.ready == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m llm_framework.scripts.auto_merge_pr \
            --pr-number ${{ github.event.pull_request.number }} \
            --repo-owner ${{ github.repository_owner }} \
            --repo-name ${{ github.event.repository.name }} \
            --merge-method squash

      - name: Comment on merge status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const statusFile = 'merge_status.json';
            
            if (fs.existsSync(statusFile)) {
              const status = JSON.parse(fs.readFileSync(statusFile, 'utf8'));
              
              let body = '## üîÄ Auto-Merge Status\n\n';
              
              if (status.merged) {
                body += '‚úÖ **Successfully merged!**\n\n';
                body += `Merge method: ${status.merge_method}\n`;
              } else {
                body += '‚ùå **Unable to merge**\n\n';
                body += `Reason: ${status.reason}\n\n`;
                
                if (status.validation) {
                  body += '### Validation Details\n';
                  body += `- Mergeable: ${status.validation.mergeable}\n`;
                  body += `- Checks passed: ${status.validation.checks_passed}\n`;
                  body += `- State: ${status.validation.mergeable_state}\n`;
                }
              }
              
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
