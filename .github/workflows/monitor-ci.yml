name: Monitor CI failures
on:
  workflow_run:
    types: [completed]

permissions:
  contents: read

jobs:
  report:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      actions: read
      contents: read
    steps:
      - name: Summarize failing run and upsert tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = run.id;

            // Fetch jobs for this run
            const jobsResp = await github.rest.actions.listJobsForWorkflowRun({
              owner, repo, run_id: runId, per_page: 100
            });
            const jobs = jobsResp.data.jobs || [];
            const jobSummaries = jobs.map(j => `- ${j.name}: ${j.conclusion} (${j.html_url})`).join('\n');

            const summary = [
              `Workflow: ${run.name}`,
              `Conclusion: ${run.conclusion}`,
              `Run: ${run.html_url}`,
              `Branch: ${run.head_branch}`,
              `Commit: ${run.head_sha}`,
              `Triggered by: ${run.event}`,
              '',
              'Jobs:',
              jobSummaries || '(no jobs found)'
            ].join('\n');

            const label = 'ci-monitor';
            // Ensure label exists
            try {
              await github.rest.issues.getLabel({ owner, repo, name: label });
            } catch (e) {
              await github.rest.issues.createLabel({ owner, repo, name: label, color: 'B60205', description: 'Automated CI failure reports' });
            }

            // Upsert a single tracking issue
            const issuesResp = await github.rest.issues.listForRepo({ owner, repo, state: 'open', labels: label, per_page: 10 });
            if (issuesResp.data.length > 0) {
              const issue = issuesResp.data[0];
              const newBody = (issue.body || '') + '\n\n---\n\n' + summary;
              await github.rest.issues.update({ owner, repo, issue_number: issue.number, body: newBody });
              core.info(`Updated tracking issue #${issue.number}`);
            } else {
              const created = await github.rest.issues.create({ owner, repo, title: 'CI failures monitor', body: summary, labels: [label] });
              core.info(`Created tracking issue #${created.data.number}`);
            }

            // Comment on associated PRs, if any
            const prs = run.pull_requests || [];
            for (const pr of prs) {
              if (!pr.number) continue;
              await github.rest.issues.createComment({
                owner, repo, issue_number: pr.number,
                body: `CI run failed on ${run.name} (run #${run.run_number}).\n\n${summary}`
              });
            }