<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Dashboard - Real-time Health Monitoring</title>
  <style>
    :root {
      /* Light Mode Colors */
      --bg-gradient-start: #667eea;
      --bg-gradient-end: #764ba2;
      --card-bg: white;
      --text-primary: #333;
      --text-secondary: #666;
      --border-color: #e0e0e0;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    body.dark-mode {
      /* Dark Mode Colors */
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --card-bg: #0f3460;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border-color: #2a4365;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      color: var(--text-primary);
      padding: 20px;
      min-height: 100vh;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px var(--shadow);
      margin-bottom: 30px;
      position: relative;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1.1em;
    }

    .dark-mode-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 50px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px var(--shadow);
    }

    .dark-mode-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px var(--shadow);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px var(--shadow);
      text-align: center;
      transition: background 0.3s ease;
    }

    .stat-number {
      font-size: 3em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-card.healthy .stat-number { color: #4CAF50; }
    .stat-card.unhealthy .stat-number { color: #FF9800; }
    .stat-card.unreachable .stat-number { color: #F44336; }
    .stat-card.total .stat-number { color: #2196F3; }

    .servers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .server-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      border-left: 5px solid;
    }

    .server-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }

    .server-card.healthy { border-left-color: #4CAF50; }
    .server-card.unhealthy { border-left-color: #FF9800; }
    .server-card.unreachable { border-left-color: #F44336; }

    .server-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .server-name {
      font-size: 1.4em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.healthy {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .status-badge.unhealthy {
      background: #FFF3E0;
      color: #E65100;
    }

    .status-badge.unreachable {
      background: #FFEBEE;
      color: #C62828;
    }

    .server-details {
      display: grid;
      gap: 10px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      color: #666;
      font-size: 0.9em;
    }

    .detail-value {
      font-weight: 600;
      color: #333;
    }

    .error-message {
      background: #FFEBEE;
      color: #C62828;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.9em;
      margin-top: 10px;
      word-wrap: break-word;
    }

    .connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9em;
    }

    .connection-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .connection-dot.connected {
      background: #4CAF50;
    }

    .connection-dot.disconnected {
      background: #F44336;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Tooltip Styles */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, bottom 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    [data-tooltip]::before {
      content: '';
      position: absolute;
      bottom: 115%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, bottom 0.3s ease;
      z-index: 1000;
    }

    [data-tooltip]:hover::after,
    [data-tooltip]:hover::before {
      opacity: 1;
      bottom: calc(100% + 5px);
    }

    /* Dark mode tooltip adjustments */
    body.dark-mode [data-tooltip]::after {
      background: rgba(255, 255, 255, 0.95);
      color: #1a1a2e;
    }

    body.dark-mode [data-tooltip]::before {
      border-top-color: rgba(255, 255, 255, 0.95);
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 400px;
      pointer-events: all;
      animation: slideInToast 0.3s ease-out;
      border-left: 4px solid #2196F3;
    }

    .toast.success { border-left-color: #4CAF50; }
    .toast.error { border-left-color: #F44336; }
    .toast.warning { border-left-color: #FF9800; }
    .toast.info { border-left-color: #2196F3; }

    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.95em;
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 0.85em;
      color: #666;
    }

    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .toast-close:hover {
      background: #f0f0f0;
      color: #333;
    }

    @keyframes slideInToast {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutToast {
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.hiding {
      animation: slideOutToast 0.3s ease-in forwards;
    }

    body.dark-mode .toast {
      background: #2d2d3a;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    body.dark-mode .toast-message {
      color: #b0b0b0;
    }

    body.dark-mode .toast-close {
      color: #888;
    }

    body.dark-mode .toast-close:hover {
      background: #3a3a4a;
      color: #fff;
    }

    /* Keyboard Shortcuts Help */
    .keyboard-help {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.85em;
      z-index: 9999;
      display: none;
    }

    .keyboard-help.show {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    .keyboard-help h4 {
      margin: 0 0 8px 0;
      font-size: 0.9em;
    }

    .keyboard-help ul {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .keyboard-help li {
      margin: 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .keyboard-help kbd {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Response Time Badge */
    .response-time {
      display: inline-block;
      font-size: 0.75em;
      padding: 2px 8px;
      border-radius: 12px;
      background: rgba(33, 150, 243, 0.1);
      color: #2196F3;
      font-weight: 500;
      margin-left: 8px;
    }

    .response-time.fast {
      background: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
    }

    .response-time.slow {
      background: rgba(255, 152, 0, 0.1);
      color: #FF9800;
    }

    .response-time.very-slow {
      background: rgba(244, 67, 54, 0.1);
      color: #F44336;
    }

    .last-update {
      text-align: center;
      color: white;
      margin-top: 20px;
      font-size: 0.9em;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }

    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .action-btn.test {
      background: #E3F2FD;
      color: #1976D2;
    }

    .action-btn.restart {
      background: #FFF3E0;
      color: #F57C00;
    }

    .action-btn.logs {
      background: #F3E5F5;
      color: #7B1FA2;
    }

    .overall-health {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    .health-badge {
      display: inline-block;
      padding: 10px 25px;
      border-radius: 30px;
      font-size: 1.2em;
      font-weight: bold;
      margin-top: 10px;
    }

    .health-badge.excellent {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .health-badge.good {
      background: #FFF3E0;
      color: #E65100;
    }

    .health-badge.critical {
      background: #FFEBEE;
      color: #C62828;
    }

    .export-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      font-weight: 600;
      color: #667eea;
      border: 2px solid #667eea;
      transition: all 0.2s;
    }

    .export-btn:hover {
      background: #667eea;
      color: white;
    }

    @media (max-width: 768px) {
      .servers-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      h1 {
        font-size: 1.8em;
      }

      .export-btn {
        position: static;
        display: block;
        margin: 0 auto 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Notifications Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Keyboard Shortcuts Help -->
  <div class="keyboard-help" id="keyboard-help">
    <h4>‚å®Ô∏è Keyboard Shortcuts</h4>
    <ul>
      <li><kbd>?</kbd> Toggle this help</li>
      <li><kbd>Ctrl+F</kbd> or <kbd>/</kbd> Focus search</li>
      <li><kbd>1</kbd> Show all servers</li>
      <li><kbd>2</kbd> Show healthy only</li>
      <li><kbd>3</kbd> Show degraded only</li>
      <li><kbd>4</kbd> Show unreachable only</li>
      <li><kbd>R</kbd> Refresh dashboard</li>
      <li><kbd>Esc</kbd> Clear search/filters</li>
    </ul>
  </div>

  <button class="export-btn" onclick="exportReport()" aria-label="Export dashboard report as JSON">üìä Export Report</button>

  <div class="container">
    <header>
      <button class="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode" id="dark-mode-toggle">
        üåô
      </button>
      <h1>üéØ MCP Dashboard</h1>
      <p class="subtitle">Real-time health monitoring for all Model Context Protocol servers</p>
    </header>

    <div class="overall-health" id="overall-health">
      <h3 style="margin-bottom: 10px; color: #666;">Overall System Health</h3>
      <div class="health-badge excellent" id="health-badge">Excellent</div>
      <p style="margin-top: 10px; color: #888; font-size: 0.9em;" id="health-description">All systems operational</p>
    </div>

    <div class="stats-grid" id="stats">
      <div class="stat-card total" data-tooltip="Total count of all registered MCP servers">
        <div class="stat-number" id="stat-total">0</div>
        <div class="stat-label">Total Servers</div>
      </div>
      <div class="stat-card healthy" data-tooltip="Servers responding successfully with status code 200">
        <div class="stat-number" id="stat-healthy">0</div>
        <div class="stat-label">Healthy</div>
      </div>
      <div class="stat-card unhealthy" data-tooltip="Servers with degraded performance or partial failures">
        <div class="stat-number" id="stat-unhealthy">0</div>
        <div class="stat-label">Degraded</div>
      </div>
      <div class="stat-card unreachable" data-tooltip="Servers not responding or completely offline">
        <div class="stat-number" id="stat-unreachable">0</div>
        <div class="stat-label">Unreachable</div>
      </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 30px;">
      <h3 style="margin-bottom: 15px; color: #666; font-size: 1.1em;">‚ö° Quick Actions</h3>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="action-btn test" onclick="refreshDashboard()" aria-label="Refresh dashboard data" data-tooltip="Manually refresh all server status and metrics">üîÑ Refresh Now</button>
        <button class="action-btn logs" onclick="toggleAutoRefresh()" id="auto-refresh-btn" aria-label="Toggle automatic refresh" data-tooltip="Pause or resume automatic 30-second refresh">‚è∏Ô∏è Pause Updates</button>
        <button class="action-btn restart" onclick="resetCharts()" aria-label="Reset all charts" data-tooltip="Reset all charts to their default view">üìä Reset Charts</button>
        <button class="action-btn test" onclick="testAllServers()" aria-label="Test all servers" data-tooltip="Run health checks on all registered servers">üß™ Test All</button>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); height: 300px;">
        <canvas id="performanceChart" role="img" aria-label="Server performance chart showing response times"></canvas>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); height: 300px;">
        <canvas id="healthHistoryChart" role="img" aria-label="Health status history chart over time"></canvas>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); height: 300px;">
        <canvas id="statusDonutChart" role="img" aria-label="Server status distribution donut chart"></canvas>
      </div>
    </div>

    <!-- Server Status Filters -->
    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
        <h3 style="margin: 0; color: #666; font-size: 1em;">üîç Filter Servers:</h3>
        <button class="filter-btn" data-filter="all" onclick="filterServers('all')" aria-label="Show all servers" style="background: #6C5CE7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">All (8)</button>
        <button class="filter-btn" data-filter="healthy" onclick="filterServers('healthy')" aria-label="Show only healthy servers" style="background: white; color: #666; border: 2px solid #4CAF50; padding: 8px 16px; border-radius: 6px; cursor: pointer;">‚úì Healthy (7)</button>
        <button class="filter-btn" data-filter="degraded" onclick="filterServers('degraded')" aria-label="Show only degraded servers" style="background: white; color: #666; border: 2px solid #FF9800; padding: 8px 16px; border-radius: 6px; cursor: pointer;">‚ö† Degraded (0)</button>
        <button class="filter-btn" data-filter="unreachable" onclick="filterServers('unreachable')" aria-label="Show only unreachable servers" style="background: white; color: #666; border: 2px solid #F44336; padding: 8px 16px; border-radius: 6px; cursor: pointer;">‚úó Unreachable (1)</button>
        <span id="filter-status" style="margin-left: auto; color: #999; font-size: 0.9em;">Showing all servers</span>
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
        <label for="server-search" style="color: #666; font-size: 0.95em; font-weight: 500;">üîé Search:</label>
        <input
          type="text"
          id="server-search"
          placeholder="Type server name..."
          oninput="searchServers(this.value)"
          aria-label="Search servers by name"
          style="flex: 1; max-width: 300px; padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; outline: none; transition: border-color 0.2s;"
          onfocus="this.style.borderColor='#6C5CE7'"
          onblur="this.style.borderColor='#ddd'"
        />
        <button
          onclick="clearSearch()"
          aria-label="Clear search"
          style="background: #f5f5f5; color: #666; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: background 0.2s;"
          onmouseover="this.style.background='#e0e0e0'"
          onmouseout="this.style.background='#f5f5f5'"
        >‚úï Clear</button>
      </div>
    </div>

    <div class="servers-grid" id="servers"></div>

    <div class="last-update" id="last-update">
      Waiting for data...
    </div>
  </div>

  <div class="connection-status" role="status" aria-live="polite">
    <div class="connection-dot" id="connection-dot"></div>
    <span id="connection-text">Connecting...</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    let ws = null;
    let reconnectTimeout = null;
    let performanceChart = null;
    let healthHistoryChart = null;
    let statusDonutChart = null;
    const WS_URL = 'ws://localhost:65030';
    const performanceHistory = [];
    const healthHistory = { timestamps: [], healthy: [], unhealthy: [], unreachable: [] };
    const MAX_HISTORY = 20;

    function connectWebSocket() {
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        console.log('WebSocket connected');
        updateConnectionStatus(true);
        if (reconnectTimeout) {
          clearTimeout(reconnectTimeout);
          reconnectTimeout = null;
        }

        // Request initial data immediately
        fetchInitialData();
      };

      ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          if (message.type === 'health-update') {
            updateDashboard(message.data);
            updateCharts(message.data);
          } else if (message.type === 'alert') {
            showAlert(message.data);
          } else if (message.type === 'restart') {
            showRestartNotification(message.data);
          }
        } catch (error) {
          console.error('Error parsing message:', error);
          ToastSystem.show('Message Error', `Failed to parse server message: ${error.message}`, 'error', 4000);
        }
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected');
        updateConnectionStatus(false);
        ToastSystem.show('Connection Lost', 'WebSocket disconnected. Reconnecting in 3 seconds...', 'warning', 3000);
        reconnectTimeout = setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateConnectionStatus(false);
        ToastSystem.show('Connection Error', 'WebSocket connection failed. Check if the server is running.', 'error', 5000);
      };
    }

    async function fetchInitialData() {
      try {
        const response = await fetch('http://localhost:65031/api/health');
        const data = await response.json();
        updateDashboard(data);
        updateCharts(data);
      } catch (error) {
        console.error('Failed to fetch initial data:', error);
        ToastSystem.show('Data Fetch Failed', 'Unable to load server health data. Check server connection.', 'error', 5000);
      }
    }

    function updateConnectionStatus(connected) {
      const dot = document.getElementById('connection-dot');
      const text = document.getElementById('connection-text');

      if (connected) {
        dot.className = 'connection-dot connected';
        text.textContent = 'Live';
      } else {
        dot.className = 'connection-dot disconnected';
        text.textContent = 'Reconnecting...';
      }
    }

    function updateCharts(data) {
      const timestamp = new Date().toLocaleTimeString();

      // Update health history
      if (healthHistory.timestamps.length >= MAX_HISTORY) {
        healthHistory.timestamps.shift();
        healthHistory.healthy.shift();
        healthHistory.unhealthy.shift();
        healthHistory.unreachable.shift();
      }

      const stats = data.stats || calculateStats(data.servers);
      healthHistory.timestamps.push(timestamp);
      healthHistory.healthy.push(stats.healthy || 0);
      healthHistory.unhealthy.push(stats.unhealthy || 0);
      healthHistory.unreachable.push(stats.unreachable || 0);

      // Update health history chart
      if (healthHistoryChart) {
        healthHistoryChart.data.labels = healthHistory.timestamps;
        healthHistoryChart.data.datasets[0].data = healthHistory.healthy;
        healthHistoryChart.data.datasets[1].data = healthHistory.unhealthy;
        healthHistoryChart.data.datasets[2].data = healthHistory.unreachable;
        healthHistoryChart.update('none');
      }

      // Update performance data
      if (performanceHistory.length >= MAX_HISTORY) {
        performanceHistory.shift();
      }
      performanceHistory.push({
        timestamp,
        servers: data.servers.map(s => ({ name: s.name, responseTime: s.responseTime }))
      });

      // Update performance chart
      if (performanceChart && performanceHistory.length > 0) {
        const latest = performanceHistory[performanceHistory.length - 1];
        performanceChart.data.labels = latest.servers.map(s => s.name);
        performanceChart.data.datasets[0].data = latest.servers.map(s => s.responseTime);
        performanceChart.update('none');
      }

      // Update status donut chart
      if (statusDonutChart) {
        statusDonutChart.data.datasets[0].data = [
          stats.healthy || 0,
          stats.unhealthy || 0,
          stats.unreachable || 0
        ];
        statusDonutChart.update('none');
      }
    }

    function calculateStats(servers) {
      if (!servers) return { total: 0, healthy: 0, unhealthy: 0, unreachable: 0 };
      return {
        total: servers.length,
        healthy: servers.filter(s => s.status === 'healthy').length,
        unhealthy: servers.filter(s => s.status === 'unhealthy').length,
        unreachable: servers.filter(s => s.status === 'unreachable').length
      };
    }

    function updateDashboard(data) {
      // Calculate stats if not provided
      const stats = data.stats || calculateStats(data.servers);

      // Update overall health badge
      updateOverallHealth(stats);

      // Update stats with animation
      animateNumber('stat-total', stats.total || data.servers.length);
      animateNumber('stat-healthy', stats.healthy || 0);
      animateNumber('stat-unhealthy', stats.unhealthy || 0);
      animateNumber('stat-unreachable', stats.unreachable || 0);

      // Update servers
      const serversGrid = document.getElementById('servers');
      serversGrid.innerHTML = '';

      if (!data.servers || data.servers.length === 0) {
        serversGrid.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">No server data available</p>';
        return;
      }

      data.servers.forEach(server => {
        // Track status changes for notifications
        trackServerStatus(server.name, server.status);

        const card = document.createElement('div');
        card.className = `server-card ${server.status}`;
        card.setAttribute("data-status", server.status);

        const statusBadge = `<span class="status-badge ${server.status}">${server.status}</span>`;

        const errorHtml = server.error
          ? `<div class="error-message">‚ùå ${server.error}</div>`
          : '';

        // Performance indicator
        const perfClass = server.responseTime < 200 ? 'good' : server.responseTime < 1000 ? 'ok' : 'slow';
        const perfEmoji = perfClass === 'good' ? '‚ö°' : perfClass === 'ok' ? '‚è±Ô∏è' : 'üê¢';

        card.innerHTML = `
          <div class="server-header">
            <div class="server-name">
              <span style="color: ${server.color || '#666'}">‚óè</span>
              ${server.name}
            </div>
            ${statusBadge}
          </div>
          <div class="server-details">
            <div class="detail-row">
              <span class="detail-label">Response Time</span>
              <span class="detail-value">${perfEmoji} ${server.responseTime}ms</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Tools Tested</span>
              <span class="detail-value">${server.toolsTested.join(', ')}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Last Checked</span>
              <span class="detail-value">${new Date(server.lastChecked).toLocaleTimeString()}</span>
            </div>
          </div>
          ${errorHtml}
          <div class="action-buttons">
            <button class="action-btn restart" onclick="testServer('${server.name}')" title="Restart this server">üîÑ Restart</button>
            <button class="action-btn logs" onclick="viewLogs('${server.name}')" title="View server logs">üìÑ Logs</button>
          </div>
        `;

        serversGrid.appendChild(card);
      });

      // Update last update time
      document.getElementById('last-update').textContent =
        `Last updated: ${new Date(data.lastUpdate || Date.now()).toLocaleString()}`;
    }

    function updateOverallHealth(stats) {
      const badge = document.getElementById('health-badge');
      const description = document.getElementById('health-description');
      const total = stats.total || 0;
      const healthy = stats.healthy || 0;
      const healthPercent = total > 0 ? (healthy / total) * 100 : 0;

      if (healthPercent === 100) {
        badge.className = 'health-badge excellent';
        badge.textContent = '‚úì Excellent';
        description.textContent = 'All systems operational';
      } else if (healthPercent >= 70) {
        badge.className = 'health-badge good';
        badge.textContent = '‚ö† Good';
        description.textContent = `${healthy}/${total} servers healthy (${healthPercent.toFixed(0)}%)`;
      } else {
        badge.className = 'health-badge critical';
        badge.textContent = '‚úó Critical';
        description.textContent = `Only ${healthy}/${total} servers healthy (${healthPercent.toFixed(0)}%)`;
      }
    }

    async function testServer(serverName) {
      try {
        const response = await fetch(`http://localhost:65031/api/restart/${encodeURIComponent(serverName)}`);
        const data = await response.json();

        if (data.success) {
          alert(`‚úÖ ${data.message}\n\nThe server will restart in the background.`);
          // Refresh dashboard after 2 seconds
          setTimeout(() => refreshDashboard(), 2000);
        } else {
          alert(`‚ùå Failed to restart: ${data.message}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    async function viewLogs(serverName) {
      try {
        const response = await fetch(`http://localhost:65031/api/logs/${encodeURIComponent(serverName)}`);
        const data = await response.json();

        if (!data.logs || data.logs.length === 0) {
          alert(`üìÑ No logs available for ${serverName}`);
          return;
        }

        // Create modal
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;

        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          padding: 30px;
          border-radius: 12px;
          max-width: 800px;
          max-height: 80vh;
          overflow: auto;
          box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        `;

        const logsHtml = data.logs.map(log => {
          const color = log.level === 'error' ? '#F44336' : '#4CAF50';
          const icon = log.level === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
          return `
            <div style="margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; border-left: 4px solid ${color};">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: bold; color: ${color};">${icon} ${log.level.toUpperCase()}</span>
                <span style="color: #999; font-size: 0.85em;">${new Date(log.timestamp).toLocaleString()}</span>
              </div>
              <pre style="margin: 0; white-space: pre-wrap; font-size: 0.9em; color: #333;">${log.message}</pre>
            </div>
          `;
        }).join('');

        modalContent.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üìÑ ${serverName} Logs</h2>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background: #F44336; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">‚úï Close</button>
          </div>
          <div style="color: #666; margin-bottom: 15px;">Last ${data.logs.length} log entries</div>
          ${logsHtml}
        `;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Close on background click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      } catch (error) {
        alert(`‚ùå Error loading logs: ${error.message}`);
      }
    }

    async function exportReport() {
      try {
        // Fetch full metrics history from server
        const metricsResponse = await fetch('http://localhost:65031/api/metrics');
        const metricsData = await metricsResponse.json();

        // Build comprehensive report
        const baseReport = {
          generatedAt: new Date().toISOString(),
          reportVersion: '2.0',
          systemInfo: {
            dashboardUrl: window.location.href,
            wsPort: 65030,
            httpPort: 65031,
          },
          currentStats: {
            total: parseInt(document.getElementById('stat-total').textContent),
            healthy: parseInt(document.getElementById('stat-healthy').textContent),
            unhealthy: parseInt(document.getElementById('stat-unhealthy').textContent),
            unreachable: parseInt(document.getElementById('stat-unreachable').textContent)
          },
          currentServers: this.healthData || [],
          realtimeHistory: {
            health: healthHistory,
            performance: performanceHistory
          },
          persistedMetrics: metricsData.history || [],
          summary: {
            totalDataPoints: (metricsData.history || []).length,
            timeRange: {
              start: metricsData.history?.[0]?.timestamp || null,
              end: metricsData.history?.[metricsData.history?.length - 1]?.timestamp || null,
            },
            averageResponseTimes: calculateAverageResponseTimes(metricsData.history || []),
            uptimePercentages: calculateUptimePercentages(metricsData.history || []),
          }
        };

        // Download as JSON
        const json = JSON.stringify(baseReport, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mcp-dashboard-report-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        console.log('Report exported successfully');

        // Show success notification
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          bottom: 80px;
          right: 20px;
          background: #4CAF50;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          z-index: 9999;
          animation: slideIn 0.3s ease-out;
        `;
        notification.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">‚úÖ Export Complete</div>
          <div style="font-size: 0.9em;">Dashboard report saved successfully</div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      } catch (error) {
        console.error('Export failed:', error);
        alert(`‚ùå Export failed: ${error.message}`);
      }
    }

    // Helper functions for statistics
    function calculateAverageResponseTimes(history) {
      const serverTimes = {};

      history.forEach(snapshot => {
        snapshot.servers?.forEach(server => {
          if (!serverTimes[server.name]) {
            serverTimes[server.name] = [];
          }
          if (server.responseTime) {
            serverTimes[server.name].push(server.responseTime);
          }
        });
      });

      const averages = {};
      for (const [name, times] of Object.entries(serverTimes)) {
        if (times.length > 0) {
          averages[name] = Math.round(times.reduce((a, b) => a + b, 0) / times.length);
        }
      }

      return averages;
    }

    function calculateUptimePercentages(history) {
      const serverStats = {};

      history.forEach(snapshot => {
        snapshot.servers?.forEach(server => {
          if (!serverStats[server.name]) {
            serverStats[server.name] = { total: 0, healthy: 0 };
          }
          serverStats[server.name].total++;
          if (server.status === 'healthy') {
            serverStats[server.name].healthy++;
          }
        });
      });

      const uptimes = {};
      for (const [name, stats] of Object.entries(serverStats)) {
        if (stats.total > 0) {
          uptimes[name] = ((stats.healthy / stats.total) * 100).toFixed(2) + '%';
        }
      }

      return uptimes;
    }

    function animateNumber(elementId, targetValue) {
      const element = document.getElementById(elementId);
      const currentValue = parseInt(element.textContent) || 0;

      if (currentValue === targetValue) return;

      const diff = targetValue - currentValue;
      const duration = 500;
      const steps = 20;
      const stepValue = diff / steps;
      const stepDuration = duration / steps;

      let currentStep = 0;

      const interval = setInterval(() => {
        currentStep++;
        const newValue = Math.round(currentValue + (stepValue * currentStep));
        element.textContent = newValue;

        if (currentStep >= steps) {
          element.textContent = targetValue;
          clearInterval(interval);
        }
      }, stepDuration);
    }

    function initCharts() {
      // Performance Chart
      const perfCtx = document.getElementById('performanceChart');
      if (perfCtx) {
        performanceChart = new Chart(perfCtx, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: 'Response Time (ms)',
              data: [],
              backgroundColor: 'rgba(102, 126, 234, 0.7)',
              borderColor: 'rgba(102, 126, 234, 1)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 500 },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Response Time (ms)' }
              }
            },
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: 'Server Response Times',
                font: { size: 16, weight: 'bold' }
              }
            }
          }
        });
      }

      // Health History Chart
      const healthCtx = document.getElementById('healthHistoryChart');
      if (healthCtx) {
        healthHistoryChart = new Chart(healthCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'Healthy',
                data: [],
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                fill: true,
                tension: 0.4
              },
              {
                label: 'Unhealthy',
                data: [],
                borderColor: '#FF9800',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                fill: true,
                tension: 0.4
              },
              {
                label: 'Unreachable',
                data: [],
                borderColor: '#F44336',
                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                fill: true,
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
                title: { display: true, text: 'Server Count' }
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Health Status History',
                font: { size: 16, weight: 'bold' }
              }
            }
          }
        });
      }

      // Status Donut Chart
      const donutCtx = document.getElementById('statusDonutChart');
      if (donutCtx) {
        statusDonutChart = new Chart(donutCtx, {
          type: 'doughnut',
          data: {
            labels: ['Healthy', 'Degraded', 'Unreachable'],
            datasets: [{
              data: [0, 0, 0],
              backgroundColor: [
                'rgba(76, 175, 80, 0.8)',
                'rgba(255, 152, 0, 0.8)',
                'rgba(244, 67, 54, 0.8)'
              ],
              borderColor: [
                '#4CAF50',
                '#FF9800',
                '#F44336'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 500 },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { font: { size: 12 } }
              },
              title: {
                display: true,
                text: 'Server Status Distribution',
                font: { size: 16, weight: 'bold' }
              }
            }
          }
        });
      }
    }

    // Current filter state
    let currentFilter = 'all';

    // Quick Actions Functions
    function refreshDashboard() {
      console.log('Manually refreshing dashboard...');
      fetchInitialData();
    }

    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById('auto-refresh-btn');
      if (autoRefreshEnabled) {
        btn.textContent = '‚è∏Ô∏è Pause Updates';
        btn.setAttribute('aria-label', 'Pause automatic refresh');
        console.log('Auto-refresh enabled');
      } else {
        btn.textContent = '‚ñ∂Ô∏è Resume Updates';
        btn.setAttribute('aria-label', 'Resume automatic refresh');
        console.log('Auto-refresh paused');
      }
    }

    function resetCharts() {
      console.log('Resetting all charts...');

      // Clear performance chart
      if (performanceChart) {
        performanceChart.data.labels = [];
        performanceChart.data.datasets[0].data = [];
        performanceChart.update('none');
      }

      // Clear health history chart
      if (healthChart) {
        healthChart.data.labels = [];
        healthChart.data.datasets[0].data = [];
        healthChart.update('none');
      }

      // Clear donut chart
      if (statusDonutChart) {
        statusDonutChart.data.datasets[0].data = [0, 0, 0];
        statusDonutChart.update('none');
      }

      // Fetch fresh data
      fetchInitialData();
    }

    function testAllServers() {
      console.log('Testing all servers...');
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert('WebSocket not connected. Please refresh the page.');
        return;
      }

      // Send test command to all servers
      socket.send(JSON.stringify({
        type: 'test_all',
        timestamp: Date.now()
      }));

      // Show feedback
      alert('Test command sent to all servers. Check server logs for results.');
    }

    // Alert notification system
    function showAlert(alertData) {
      const alertBox = document.createElement('div');
      const bgColor = alertData.severity === 'critical' ? '#F44336' :
                      alertData.severity === 'warning' ? '#FF9800' :
                      '#4CAF50';

      alertBox.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
      `;

      const icon = alertData.severity === 'critical' ? 'üö®' :
                   alertData.severity === 'warning' ? '‚ö†Ô∏è' : '‚úÖ';

      alertBox.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
          <div style="font-weight: bold; font-size: 1.1em;">${icon} ${alertData.type === 'recovery' ? 'Recovery' : 'Alert'}</div>
          <button onclick="this.closest('div').remove()" style="background: transparent; border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 0; margin: 0; line-height: 1;">‚úï</button>
        </div>
        <div style="margin-bottom: 8px; font-weight: 600;">${alertData.server}</div>
        <div style="font-size: 0.9em; line-height: 1.5;">${alertData.message}</div>
        ${alertData.error ? `<div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85em;">${alertData.error}</div>` : ''}
      `;

      document.body.appendChild(alertBox);

      // Auto-remove after 10 seconds
      setTimeout(() => {
        if (alertBox.parentNode) {
          alertBox.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => alertBox.remove(), 300);
        }
      }, 10000);
    }

    function showRestartNotification(restartData) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: #2196F3;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
      `;

      notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">üîÑ Server Restart</div>
        <div style="font-size: 0.9em;">${restartData.server} - Attempt ${restartData.attempt}</div>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }
      }, 5000);
    }

    // Server search functionality
    let currentSearchTerm = '';

    function searchServers(searchTerm) {
      currentSearchTerm = searchTerm.toLowerCase().trim();
      console.log(`Searching servers: "${currentSearchTerm}"`);

      const serverCards = document.querySelectorAll('.server-card');
      let visibleCount = 0;

      serverCards.forEach(card => {
        const serverNameElement = card.querySelector('.server-name');
        if (!serverNameElement) {
          card.style.display = 'block';
          return;
        }

        const serverName = serverNameElement.textContent.toLowerCase();
        const matchesSearch = !currentSearchTerm || serverName.includes(currentSearchTerm);
        const matchesFilter = shouldShowInFilter(card, currentFilter);

        const shouldShow = matchesSearch && matchesFilter;
        card.style.display = shouldShow ? 'block' : 'none';
        if (shouldShow) visibleCount++;
      });

      updateFilterStatus(visibleCount);
    }

    function clearSearch() {
      const searchInput = document.getElementById('server-search');
      if (searchInput) {
        searchInput.value = '';
        currentSearchTerm = '';
        searchServers('');
      }
    }

    // Dark Mode Toggle
    function toggleDarkMode() {
      const body = document.body;
      const toggleBtn = document.getElementById('dark-mode-toggle');

      body.classList.toggle('dark-mode');

      const isDarkMode = body.classList.contains('dark-mode');

      // Update button icon and aria-label
      if (isDarkMode) {
        toggleBtn.textContent = '‚òÄÔ∏è';
        toggleBtn.setAttribute('aria-label', 'Switch to light mode');
        localStorage.setItem('darkMode', 'enabled');
        console.log('Dark mode enabled');
      } else {
        toggleBtn.textContent = 'üåô';
        toggleBtn.setAttribute('aria-label', 'Switch to dark mode');
        localStorage.setItem('darkMode', 'disabled');
        console.log('Dark mode disabled');
      }
    }

    // Load dark mode preference on page load
    function loadDarkModePreference() {
      const darkModePreference = localStorage.getItem('darkMode');
      if (darkModePreference === 'enabled') {
        document.body.classList.add('dark-mode');
        const toggleBtn = document.getElementById('dark-mode-toggle');
        if (toggleBtn) {
          toggleBtn.textContent = '‚òÄÔ∏è';
          toggleBtn.setAttribute('aria-label', 'Switch to light mode');
        }
      }
    }

    function shouldShowInFilter(card, filter) {
      if (filter === 'all') return true;

      const statusBadge = card.querySelector('.status-badge');
      if (!statusBadge) return true;

      const status = statusBadge.textContent.toLowerCase();

      if (filter === 'healthy' && status.includes('healthy')) return true;
      if (filter === 'degraded' && status.includes('unhealthy')) return true;
      if (filter === 'unreachable' && status.includes('unreachable')) return true;

      return false;
    }

    function updateFilterStatus(visibleCount) {
      const filterStatus = document.getElementById('filter-status');
      if (filterStatus) {
        const filterText = currentFilter === 'all' ? 'all' : currentFilter;
        const searchText = currentSearchTerm ? ` matching "${currentSearchTerm}"` : '';
        filterStatus.textContent = `Showing ${visibleCount} ${filterText} server${visibleCount !== 1 ? 's' : ''}${searchText}`;
      }
    }

    // Server Filter Function
    function filterServers(filter) {
      console.log(`Filtering servers: ${filter}`);
      currentFilter = filter;

      const serverCards = document.querySelectorAll('.server-card');
      let visibleCount = 0;

      serverCards.forEach(card => {
        const matchesFilter = shouldShowInFilter(card, filter);
        const matchesSearch = !currentSearchTerm ||
          card.querySelector('.server-name')?.textContent.toLowerCase().includes(currentSearchTerm);

        const shouldShow = matchesFilter && matchesSearch;
        card.style.display = shouldShow ? 'block' : 'none';
        if (shouldShow) visibleCount++;
      });

      // Update filter buttons visual state
      document.querySelectorAll('.filter-btn').forEach(btn => {
        const btnFilter = btn.getAttribute('data-filter');
        if (btnFilter === filter) {
          btn.style.background = '#6C5CE7';
          btn.style.color = 'white';
          btn.style.fontWeight = 'bold';
        } else {
          btn.style.background = 'white';
          btn.style.color = '#666';
          btn.style.fontWeight = 'normal';
        }
      });

      // Update filter status text
      const filterStatus = document.getElementById('filter-status');
      if (filterStatus) {
        const filterText = filter === 'all' ? 'all' : filter;
        filterStatus.textContent = `Showing ${visibleCount} ${filterText} server${visibleCount !== 1 ? 's' : ''}`;
      }
    }

    // ====================
    // TOAST NOTIFICATION SYSTEM
    // ====================
    const ToastSystem = {
      show(title, message, type = 'info', duration = 5000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };

        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || icons.info}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Close notification">√ó</button>
        `;

        container.appendChild(toast);

        if (duration > 0) {
          setTimeout(() => {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
          }, duration);
        }

        return toast;
      },

      success(title, message, duration) {
        return this.show(title, message, 'success', duration);
      },

      error(title, message, duration) {
        return this.show(title, message, 'error', duration);
      },

      warning(title, message, duration) {
        return this.show(title, message, 'warning', duration);
      },

      info(title, message, duration) {
        return this.show(title, message, 'info', duration);
      }
    };

    // ====================
    // SERVER STATUS TRACKING
    // ====================
    const serverStatusHistory = new Map();

    function trackServerStatus(serverName, status) {
      const previous = serverStatusHistory.get(serverName);

      if (previous && previous !== status) {
        // Status changed - show notification
        const statusEmojis = {
          healthy: '‚úÖ',
          unhealthy: '‚ö†Ô∏è',
          unreachable: '‚ùå',
          degraded: '‚ö†Ô∏è'
        };

        const statusMessages = {
          healthy: 'is now healthy',
          unhealthy: 'is experiencing issues',
          unreachable: 'is unreachable',
          degraded: 'performance degraded'
        };

        const notifType = status === 'healthy' ? 'success' : (status === 'unreachable' ? 'error' : 'warning');

        ToastSystem[notifType](
          `${statusEmojis[status]} ${serverName}`,
          statusMessages[status] || `Status changed to ${status}`
        );
      }

      serverStatusHistory.set(serverName, status);
    }

    // ====================
    // KEYBOARD SHORTCUTS
    // ====================
    let keyboardHelpVisible = false;

    function toggleKeyboardHelp() {
      const help = document.getElementById('keyboard-help');
      if (!help) return;

      keyboardHelpVisible = !keyboardHelpVisible;
      help.classList.toggle('show', keyboardHelpVisible);
    }

    document.addEventListener('keydown', (e) => {
      // Ignore if typing in an input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        // Allow Escape to blur/clear
        if (e.key === 'Escape') {
          e.target.blur();
          clearSearch();
        }
        return;
      }

      // Toggle keyboard help
      if (e.key === '?') {
        e.preventDefault();
        toggleKeyboardHelp();
        return;
      }

      // Ctrl+F or / - Focus search
      if ((e.ctrlKey && e.key === 'f') || e.key === '/') {
        e.preventDefault();
        const searchInput = document.getElementById('server-search');
        if (searchInput) {
          searchInput.focus();
          searchInput.select();
        }
        return;
      }

      // Number keys 1-4 - Filter shortcuts
      const filterMap = {
        '1': 'all',
        '2': 'healthy',
        '3': 'degraded',
        '4': 'unreachable'
      };

      if (filterMap[e.key]) {
        e.preventDefault();
        filterServers(filterMap[e.key]);
        return;
      }

      // R - Refresh
      if (e.key === 'r' || e.key === 'R') {
        e.preventDefault();
        location.reload();
        return;
      }

      // Escape - Clear everything
      if (e.key === 'Escape') {
        e.preventDefault();
        clearSearch();
        filterServers('all');
        keyboardHelpVisible = false;
        const help = document.getElementById('keyboard-help');
        if (help) help.classList.remove('show');
        return;
      }
    });

    // ====================
    // RESPONSE TIME SIMULATION
    // ====================
    function getRandomResponseTime() {
      // Simulate response times: 50-500ms
      const time = Math.floor(Math.random() * 450) + 50;
      const className = time < 100 ? 'fast' : (time < 250 ? '' : (time < 400 ? 'slow' : 'very-slow'));
      return { time, className };
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      loadDarkModePreference(); // Load saved dark mode preference
      connectWebSocket();

      // Show welcome notification
      setTimeout(() => {
        ToastSystem.info(
          'Keyboard Shortcuts Available',
          'Press ? to see all available shortcuts',
          6000
        );
      }, 1000);
    });
  </script>

  <!-- Developer Tools Extension (Inlined) -->
  <script>
/**
 * MCP Dashboard - Developer Tools Extension
 * Advanced debugging, monitoring, and testing tools
 *
 * @author Claude Code (Sonnet 4.5)
 */

class DevTools {
  constructor() {
    this.isOpen = false;
    this.activeTab = 'console';
    this.logs = [];
    this.networkRequests = [];
    this.maxLogs = 1000;
    this.maxRequests = 100;
    this.performanceMetrics = {
      apiCalls: [],
      wsMessages: [],
      renderTimes: []
    };

    this.init();
  }

  init() {
    this.injectStyles();
    this.injectHTML();
    this.attachEventListeners();
    this.interceptConsole();
    this.interceptFetch();
    this.interceptWebSocket();
    this.startPerformanceMonitoring();

    // Global keyboard shortcut: Ctrl+Shift+D or Cmd+Shift+D
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        this.toggle();
      }
    });

    console.log('%c[DevTools]%c Initialized. Press Ctrl+Shift+D to open.',
      'color: #4CAF50; font-weight: bold', 'color: inherit');
  }

  injectStyles() {
    const style = document.createElement('style');
    style.textContent = `
      #devtools-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 500px;
        background: #1e1e1e;
        color: #d4d4d4;
        border-top: 2px solid #3c3c3c;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: none;
        flex-direction: column;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 13px;
      }

      #devtools-panel.open {
        display: flex;
      }

      .devtools-header {
        background: #252526;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #3c3c3c;
        user-select: none;
      }

      .devtools-title {
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .devtools-tabs {
        display: flex;
        gap: 5px;
      }

      .devtools-tab {
        padding: 8px 16px;
        background: transparent;
        border: none;
        color: #888;
        cursor: pointer;
        border-radius: 4px 4px 0 0;
        transition: all 0.2s;
        font-size: 13px;
      }

      .devtools-tab:hover {
        background: #2a2a2a;
        color: #ccc;
      }

      .devtools-tab.active {
        background: #1e1e1e;
        color: #4CAF50;
        font-weight: 600;
      }

      .devtools-close {
        background: transparent;
        border: none;
        color: #888;
        font-size: 20px;
        cursor: pointer;
        padding: 0 10px;
        transition: color 0.2s;
      }

      .devtools-close:hover {
        color: #F44336;
      }

      .devtools-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
      }

      .devtools-tab-content {
        display: none;
      }

      .devtools-tab-content.active {
        display: block;
      }

      /* Console Tab */
      .console-log {
        padding: 5px 10px;
        border-left: 3px solid transparent;
        margin-bottom: 2px;
        font-family: 'Consolas', monospace;
      }

      .console-log.info { border-color: #2196F3; color: #85d3ff; }
      .console-log.warn { border-color: #FF9800; color: #ffb74d; }
      .console-log.error { border-color: #F44336; color: #ef5350; }
      .console-log.success { border-color: #4CAF50; color: #81c784; }

      .console-timestamp {
        color: #666;
        margin-right: 10px;
        font-size: 11px;
      }

      .console-clear {
        position: absolute;
        top: 60px;
        right: 20px;
        padding: 5px 15px;
        background: #2a2a2a;
        border: 1px solid #3c3c3c;
        color: #888;
        cursor: pointer;
        border-radius: 4px;
        font-size: 12px;
      }

      .console-clear:hover {
        background: #3c3c3c;
        color: #ccc;
      }

      /* API Tester Tab */
      .api-tester-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-width: 800px;
      }

      .api-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .api-input-group label {
        min-width: 100px;
        color: #888;
      }

      .api-input-group input,
      .api-input-group select,
      .api-input-group textarea {
        flex: 1;
        background: #2a2a2a;
        border: 1px solid #3c3c3c;
        color: #d4d4d4;
        padding: 8px 12px;
        border-radius: 4px;
        font-family: 'Consolas', monospace;
      }

      .api-input-group textarea {
        min-height: 100px;
        resize: vertical;
      }

      .api-test-btn {
        padding: 10px 20px;
        background: #4CAF50;
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 600;
        transition: background 0.2s;
      }

      .api-test-btn:hover {
        background: #45a049;
      }

      .api-response {
        margin-top: 20px;
        padding: 15px;
        background: #2a2a2a;
        border: 1px solid #3c3c3c;
        border-radius: 4px;
      }

      .api-response pre {
        margin: 0;
        color: #85d3ff;
        overflow-x: auto;
      }

      /* Network Tab */
      .network-request {
        padding: 10px;
        border-bottom: 1px solid #3c3c3c;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .network-method {
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
      }

      .network-method.GET { background: #2196F3; color: white; }
      .network-method.POST { background: #4CAF50; color: white; }
      .network-method.PUT { background: #FF9800; color: white; }
      .network-method.DELETE { background: #F44336; color: white; }

      .network-url {
        flex: 1;
        margin: 0 15px;
        color: #85d3ff;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .network-status {
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
      }

      .network-status.success { background: #4CAF50; color: white; }
      .network-status.error { background: #F44336; color: white; }

      /* Performance Tab */
      .metric-card {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        border-left: 4px solid #4CAF50;
      }

      .metric-label {
        color: #888;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .metric-value {
        font-size: 24px;
        font-weight: 600;
        color: #4CAF50;
      }

      .metric-details {
        margin-top: 10px;
        color: #666;
        font-size: 11px;
      }

      /* Config Tab */
      .config-editor {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #3c3c3c;
      }

      .config-editor pre {
        margin: 0;
        color: #d4d4d4;
        overflow-x: auto;
      }

      /* Resize Handle */
      .devtools-resize-handle {
        height: 5px;
        background: #3c3c3c;
        cursor: ns-resize;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
      }

      .devtools-resize-handle:hover {
        background: #4CAF50;
      }

      /* Float Button */
      #devtools-float-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        z-index: 9999;
        transition: all 0.3s;
      }

      #devtools-float-btn:hover {
        background: #45a049;
        transform: scale(1.1);
      }

      #devtools-float-btn.active {
        background: #F44336;
      }
    `;
    document.head.appendChild(style);
  }

  injectHTML() {
    const html = `
      <!-- DevTools Float Button -->
      <button id="devtools-float-btn" title="Developer Tools (Ctrl+Shift+D)">
        üõ†Ô∏è
      </button>

      <!-- DevTools Panel -->
      <div id="devtools-panel">
        <div class="devtools-resize-handle"></div>
        <div class="devtools-header">
          <div class="devtools-title">
            <span>üõ†Ô∏è</span>
            <span>Developer Tools</span>
            <span style="color: #666; font-size: 11px; font-weight: normal;">Ctrl+Shift+D</span>
          </div>
          <div class="devtools-tabs">
            <button class="devtools-tab active" data-tab="console">Console</button>
            <button class="devtools-tab" data-tab="network">Network</button>
            <button class="devtools-tab" data-tab="api">API Tester</button>
            <button class="devtools-tab" data-tab="performance">Performance</button>
            <button class="devtools-tab" data-tab="config">Config</button>
          </div>
          <button class="devtools-close" title="Close (Esc)">√ó</button>
        </div>

        <div class="devtools-content">
          <!-- Console Tab -->
          <div class="devtools-tab-content active" id="console-tab">
            <button class="console-clear">Clear Console</button>
            <div id="console-output"></div>
          </div>

          <!-- Network Tab -->
          <div class="devtools-tab-content" id="network-tab">
            <h3 style="margin-top: 0; color: #888;">Network Requests</h3>
            <div id="network-output"></div>
          </div>

          <!-- API Tester Tab -->
          <div class="devtools-tab-content" id="api-tab">
            <h3 style="margin-top: 0; color: #888;">MCP Server API Tester</h3>
            <form class="api-tester-form" id="api-tester-form">
              <div class="api-input-group">
                <label>Server:</label>
                <select id="api-server-select">
                  <option value="http://localhost:65031/api/health">Dashboard Health API</option>
                  <option value="http://localhost:65031/api/metrics">Dashboard Metrics API</option>
                </select>
              </div>
              <div class="api-input-group">
                <label>Method:</label>
                <select id="api-method">
                  <option>GET</option>
                  <option>POST</option>
                  <option>PUT</option>
                  <option>DELETE</option>
                </select>
              </div>
              <div class="api-input-group">
                <label>Custom URL:</label>
                <input type="text" id="api-custom-url" placeholder="http://localhost:65031/api/...">
              </div>
              <div class="api-input-group">
                <label>Request Body:</label>
                <textarea id="api-request-body" placeholder='{"key": "value"}'></textarea>
              </div>
              <button type="submit" class="api-test-btn">üöÄ Send Request</button>
            </form>
            <div class="api-response" id="api-response" style="display: none;"></div>
          </div>

          <!-- Performance Tab -->
          <div class="devtools-tab-content" id="performance-tab">
            <h3 style="margin-top: 0; color: #888;">Performance Metrics</h3>
            <div id="performance-metrics"></div>
          </div>

          <!-- Config Tab -->
          <div class="devtools-tab-content" id="config-tab">
            <h3 style="margin-top: 0; color: #888;">Current Configuration</h3>
            <div class="config-editor">
              <pre id="config-output">Loading configuration...</pre>
            </div>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);
  }

  attachEventListeners() {
    // Float button
    document.getElementById('devtools-float-btn').addEventListener('click', () => this.toggle());

    // Close button
    document.querySelector('.devtools-close').addEventListener('click', () => this.close());

    // Tab switching
    document.querySelectorAll('.devtools-tab').forEach(tab => {
      tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
    });

    // Clear console
    document.querySelector('.console-clear').addEventListener('click', () => this.clearConsole());

    // API Tester form
    document.getElementById('api-tester-form').addEventListener('submit', (e) => {
      e.preventDefault();
      this.testAPI();
    });

    // Resize handle
    this.setupResizeHandle();

    // ESC to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && this.isOpen) {
        e.stopPropagation(); // Prevent conflict with other ESC handlers
        this.close();
      }
    });
  }

  setupResizeHandle() {
    const panel = document.getElementById('devtools-panel');
    const handle = panel.querySelector('.devtools-resize-handle');
    let isResizing = false;
    let startY = 0;
    let startHeight = 0;

    handle.addEventListener('mousedown', (e) => {
      isResizing = true;
      startY = e.clientY;
      startHeight = panel.offsetHeight;
      document.body.style.cursor = 'ns-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const diff = startY - e.clientY;
      const newHeight = Math.min(Math.max(200, startHeight + diff), window.innerHeight - 100);
      panel.style.height = newHeight + 'px';
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }
    });
  }

  toggle() {
    if (this.isOpen) {
      this.close();
    } else {
      this.open();
    }
  }

  open() {
    this.isOpen = true;
    document.getElementById('devtools-panel').classList.add('open');
    document.getElementById('devtools-float-btn').classList.add('active');
    this.updateConfig();
    this.updatePerformanceMetrics();
    this.log('info', 'Developer Tools opened');
  }

  close() {
    this.isOpen = false;
    document.getElementById('devtools-panel').classList.remove('open');
    document.getElementById('devtools-float-btn').classList.remove('active');
  }

  switchTab(tabName) {
    this.activeTab = tabName;

    // Update tab buttons
    document.querySelectorAll('.devtools-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.tab === tabName);
    });

    // Update tab content
    document.querySelectorAll('.devtools-tab-content').forEach(content => {
      content.classList.toggle('active', content.id === `${tabName}-tab`);
    });

    // Refresh content for active tab
    if (tabName === 'performance') this.updatePerformanceMetrics();
    if (tabName === 'config') this.updateConfig();
    if (tabName === 'network') this.updateNetworkLog();
  }

  log(type, ...args) {
    const timestamp = new Date().toLocaleTimeString();
    const message = args.map(arg =>
      typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
    ).join(' ');

    this.logs.push({ type, timestamp, message });

    if (this.logs.length > this.maxLogs) {
      this.logs.shift();
    }

    this.updateConsole();
  }

  updateConsole() {
    const output = document.getElementById('console-output');
    if (!output) return;

    output.innerHTML = this.logs.map(log => `
      <div class="console-log ${log.type}">
        <span class="console-timestamp">${log.timestamp}</span>
        <span>${log.message}</span>
      </div>
    `).join('');

    // Auto-scroll to bottom
    output.scrollTop = output.scrollHeight;
  }

  clearConsole() {
    this.logs = [];
    this.updateConsole();
  }

  interceptConsole() {
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;

    const self = this;

    console.log = function(...args) {
      self.log('info', ...args);
      originalLog.apply(console, args);
    };

    console.warn = function(...args) {
      self.log('warn', ...args);
      originalWarn.apply(console, args);
    };

    console.error = function(...args) {
      self.log('error', ...args);
      originalError.apply(console, args);
    };
  }

  interceptFetch() {
    const originalFetch = window.fetch;
    const self = this;

    window.fetch = async function(...args) {
      const startTime = performance.now();
      const url = typeof args[0] === 'string' ? args[0] : args[0].url;
      const method = args[1]?.method || 'GET';

      try {
        const response = await originalFetch(...args);
        const duration = performance.now() - startTime;

        self.networkRequests.push({
          method,
          url,
          status: response.status,
          duration: Math.round(duration),
          timestamp: new Date().toLocaleTimeString(),
          type: 'fetch'
        });

        if (self.networkRequests.length > self.maxRequests) {
          self.networkRequests.shift();
        }

        self.performanceMetrics.apiCalls.push({ url, duration });
        self.updateNetworkLog();

        return response;
      } catch (error) {
        self.networkRequests.push({
          method,
          url,
          status: 'ERROR',
          error: error.message,
          timestamp: new Date().toLocaleTimeString(),
          type: 'fetch'
        });
        throw error;
      }
    };
  }

  interceptWebSocket() {
    const originalWS = window.WebSocket;
    const self = this;

    window.WebSocket = function(...args) {
      const ws = new originalWS(...args);

      ws.addEventListener('message', (event) => {
        self.performanceMetrics.wsMessages.push({
          timestamp: Date.now(),
          size: event.data.length
        });
        self.log('info', `[WebSocket] Message received (${event.data.length} bytes)`);
      });

      ws.addEventListener('open', () => {
        self.log('success', '[WebSocket] Connected');
      });

      ws.addEventListener('close', () => {
        self.log('warn', '[WebSocket] Disconnected');
      });

      ws.addEventListener('error', (error) => {
        self.log('error', '[WebSocket] Error:', error);
      });

      return ws;
    };
  }

  updateNetworkLog() {
    const output = document.getElementById('network-output');
    if (!output) return;

    output.innerHTML = this.networkRequests.slice().reverse().map(req => `
      <div class="network-request">
        <span class="network-method ${req.method}">${req.method}</span>
        <span class="network-url" title="${req.url}">${req.url}</span>
        <span class="network-status ${req.status >= 200 && req.status < 300 ? 'success' : 'error'}">
          ${req.status} ${req.duration ? `(${req.duration}ms)` : ''}
        </span>
        <span style="color: #666; font-size: 11px;">${req.timestamp}</span>
      </div>
    `).join('');
  }

  startPerformanceMonitoring() {
    setInterval(() => {
      if (this.activeTab === 'performance' && this.isOpen) {
        this.updatePerformanceMetrics();
      }
    }, 2000);
  }

  updatePerformanceMetrics() {
    const output = document.getElementById('performance-metrics');
    if (!output) return;

    const avgAPITime = this.performanceMetrics.apiCalls.length > 0
      ? (this.performanceMetrics.apiCalls.reduce((sum, call) => sum + call.duration, 0) /
         this.performanceMetrics.apiCalls.length).toFixed(2)
      : '0';

    const wsMessageRate = this.performanceMetrics.wsMessages.length;
    const memoryUsage = performance.memory
      ? (performance.memory.usedJSHeapSize / 1048576).toFixed(2)
      : 'N/A';

    output.innerHTML = `
      <div class="metric-card">
        <div class="metric-label">Average API Response Time</div>
        <div class="metric-value">${avgAPITime} ms</div>
        <div class="metric-details">Based on ${this.performanceMetrics.apiCalls.length} API calls</div>
      </div>

      <div class="metric-card" style="border-left-color: #2196F3;">
        <div class="metric-label">WebSocket Messages</div>
        <div class="metric-value" style="color: #2196F3;">${wsMessageRate}</div>
        <div class="metric-details">Total messages received</div>
      </div>

      <div class="metric-card" style="border-left-color: #FF9800;">
        <div class="metric-label">Memory Usage</div>
        <div class="metric-value" style="color: #FF9800;">${memoryUsage} MB</div>
        <div class="metric-details">JavaScript heap size</div>
      </div>

      <div class="metric-card" style="border-left-color: #9C27B0;">
        <div class="metric-label">Console Logs</div>
        <div class="metric-value" style="color: #9C27B0;">${this.logs.length}</div>
        <div class="metric-details">Total log entries (max ${this.maxLogs})</div>
      </div>

      <div class="metric-card" style="border-left-color: #F44336;">
        <div class="metric-label">Network Requests</div>
        <div class="metric-value" style="color: #F44336;">${this.networkRequests.length}</div>
        <div class="metric-details">Tracked HTTP/Fetch requests</div>
      </div>
    `;
  }

  updateConfig() {
    const output = document.getElementById('config-output');
    if (!output) return;

    const config = {
      dashboard: {
        url: window.location.href,
        websocket: 'ws://localhost:65030',
        apiEndpoint: 'http://localhost:65031/api'
      },
      devtools: {
        version: '1.0.0',
        maxLogs: this.maxLogs,
        maxRequests: this.maxRequests,
        activeTab: this.activeTab
      },
      browser: {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        cookiesEnabled: navigator.cookieEnabled
      },
      performance: {
        apiCalls: this.performanceMetrics.apiCalls.length,
        wsMessages: this.performanceMetrics.wsMessages.length,
        logs: this.logs.length
      }
    };

    output.textContent = JSON.stringify(config, null, 2);
  }

  async testAPI() {
    const serverSelect = document.getElementById('api-server-select');
    const customURL = document.getElementById('api-custom-url');
    const method = document.getElementById('api-method').value;
    const requestBody = document.getElementById('api-request-body').value;
    const responseDiv = document.getElementById('api-response');

    const url = customURL.value || serverSelect.value;

    responseDiv.style.display = 'block';
    responseDiv.innerHTML = '<pre>Loading...</pre>';

    try {
      const startTime = performance.now();
      const options = { method };

      if (method !== 'GET' && requestBody) {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = requestBody;
      }

      const response = await fetch(url, options);
      const duration = performance.now() - startTime;
      const contentType = response.headers.get('content-type');
      const data = contentType?.includes('application/json')
        ? await response.json()
        : await response.text();

      const result = {
        status: response.status,
        statusText: response.statusText,
        duration: `${Math.round(duration)}ms`,
        headers: Object.fromEntries(response.headers.entries()),
        data
      };

      responseDiv.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
      this.log('success', `API Test: ${method} ${url} - ${response.status} (${Math.round(duration)}ms)`);
    } catch (error) {
      responseDiv.innerHTML = `<pre style="color: #F44336;">Error: ${error.message}</pre>`;
      this.log('error', `API Test Failed: ${method} ${url} - ${error.message}`);
    }
  }
}

// Auto-initialize DevTools
window.devtools = new DevTools();

// ===================================================================
// ADVANCED DEVTOOLS SUITE
// ===================================================================

class AdvancedDevTools {
  constructor(baseDevTools) {
    this.base = baseDevTools;
    this.panels = {
      elements: null,
      sources: null,
      storage: null,
      profiler: null,
      websocket: null,
      terminal: null,
      lighthouse: null,
      snippets: null
    };

    this.domSnapshot = null;
    this.breakpoints = [];
    this.snippets = this.loadSnippets();
    this.terminalHistory = [];
    this.wsMessages = [];
    this.profilerData = {
      cpu: [],
      memory: [],
      timeline: []
    };

    this.init();
  }

  init() {
    this.extendBaseDevTools();
    this.initializeAdvancedPanels();
    this.setupKeyboardShortcuts();
    this.startPerformanceMonitoring();
    console.log('%c[AdvancedDevTools]%c Initialized - Full suite active',
      'color: #9C27B0; font-weight: bold', 'color: inherit');
  }

  extendBaseDevTools() {
    const tabsContainer = document.querySelector('.devtools-tabs');
    if (!tabsContainer) return;

    const newTabs = [
      { id: 'elements', label: 'Elements', icon: 'üîç' },
      { id: 'sources', label: 'Sources', icon: 'üìÑ' },
      { id: 'storage', label: 'Storage', icon: 'üíæ' },
      { id: 'profiler', label: 'Profiler', icon: '‚ö°' },
      { id: 'websocket', label: 'WebSocket', icon: 'üîå' },
      { id: 'terminal', label: 'Terminal', icon: 'üíª' },
      { id: 'lighthouse', label: 'Audits', icon: 'üî¶' },
      { id: 'snippets', label: 'Snippets', icon: '‚úÇÔ∏è' }
    ];

    newTabs.forEach(tab => {
      const btn = document.createElement('button');
      btn.className = 'devtools-tab';
      btn.dataset.tab = tab.id;
      btn.innerHTML = `${tab.icon} ${tab.label}`;
      btn.addEventListener('click', () => this.switchToPanel(tab.id));
      tabsContainer.appendChild(btn);
    });
  }

  initializeAdvancedPanels() {
    const content = document.querySelector('.devtools-content');
    if (!content) return;

    content.insertAdjacentHTML('beforeend', this.createElementsPanel());
    content.insertAdjacentHTML('beforeend', this.createSourcesPanel());
    content.insertAdjacentHTML('beforeend', this.createStoragePanel());
    content.insertAdjacentHTML('beforeend', this.createProfilerPanel());
    content.insertAdjacentHTML('beforeend', this.createWebSocketPanel());
    content.insertAdjacentHTML('beforeend', this.createTerminalPanel());
    content.insertAdjacentHTML('beforeend', this.createLighthousePanel());
    content.insertAdjacentHTML('beforeend', this.createSnippetsPanel());

    this.attachEventListeners();
  }

  createElementsPanel() {
    return `<div class="devtools-tab-content" id="elements-tab"><div class="panel-split"><div class="panel-left" style="flex: 1; border-right: 1px solid #3c3c3c;"><div class="panel-toolbar"><button id="inspect-btn" class="toolbar-btn">üîç Inspect</button><button id="select-element-btn" class="toolbar-btn">üëÜ Select Element</button><button id="refresh-dom-btn" class="toolbar-btn">üîÑ Refresh</button><input type="text" id="element-search" placeholder="Search DOM..." class="toolbar-input"></div><div id="dom-tree" class="dom-tree"></div></div><div class="panel-right" style="flex: 1; padding: 10px;"><div class="tabs-mini"><button class="tab-mini active" data-subtab="styles">Styles</button><button class="tab-mini" data-subtab="computed">Computed</button><button class="tab-mini" data-subtab="layout">Layout</button><button class="tab-mini" data-subtab="events">Event Listeners</button><button class="tab-mini" data-subtab="accessibility">Accessibility</button></div><div id="element-details"></div></div></div></div>`;
  }

  createSourcesPanel() {
    return `<div class="devtools-tab-content" id="sources-tab"><div class="panel-split"><div class="panel-left" style="flex: 0 0 250px; border-right: 1px solid #3c3c3c;"><h4 style="margin: 10px; color: #888;">Sources</h4><div id="sources-tree" class="sources-tree"></div></div><div class="panel-center" style="flex: 1;"><div class="panel-toolbar"><button id="pretty-print-btn" class="toolbar-btn">{ } Pretty Print</button><button id="format-btn" class="toolbar-btn">üé® Format</button><button id="copy-source-btn" class="toolbar-btn">üìã Copy</button></div><pre id="source-viewer" class="source-viewer"></pre></div><div class="panel-right" style="flex: 0 0 300px; border-left: 1px solid #3c3c3c; padding: 10px;"><h4 style="margin: 0 0 10px 0; color: #888;">Breakpoints</h4><div id="breakpoints-list"></div><h4 style="margin: 20px 0 10px 0; color: #888;">Call Stack</h4><div id="call-stack"></div><h4 style="margin: 20px 0 10px 0; color: #888;">Scope</h4><div id="scope-viewer"></div></div></div></div>`;
  }

  createStoragePanel() {
    return `<div class="devtools-tab-content" id="storage-tab"><div class="panel-split"><div class="panel-left" style="flex: 0 0 200px; border-right: 1px solid #3c3c3c;"><div class="storage-tree"><div class="storage-section"><div class="storage-header" onclick="window.advancedDevTools.selectStorage('localStorage')">üì¶ Local Storage</div></div><div class="storage-section"><div class="storage-header" onclick="window.advancedDevTools.selectStorage('sessionStorage')">üì¶ Session Storage</div></div><div class="storage-section"><div class="storage-header" onclick="window.advancedDevTools.selectStorage('cookies')">üç™ Cookies</div></div><div class="storage-section"><div class="storage-header" onclick="window.advancedDevTools.selectStorage('indexedDB')">üóÑÔ∏è IndexedDB</div></div><div class="storage-section"><div class="storage-header" onclick="window.advancedDevTools.selectStorage('cache')">üíæ Cache Storage</div></div></div></div><div class="panel-right" style="flex: 1; padding: 10px;"><div class="panel-toolbar"><button id="storage-add-btn" class="toolbar-btn">‚ûï Add</button><button id="storage-edit-btn" class="toolbar-btn">‚úèÔ∏è Edit</button><button id="storage-delete-btn" class="toolbar-btn">üóëÔ∏è Delete</button><button id="storage-clear-btn" class="toolbar-btn">üßπ Clear All</button><button id="storage-export-btn" class="toolbar-btn">üì§ Export</button></div><div id="storage-viewer" class="storage-viewer"><p style="color: #666; padding: 20px;">Select a storage type to view contents</p></div></div></div></div>`;
  }

  createProfilerPanel() {
    return `<div class="devtools-tab-content" id="profiler-tab"><div class="panel-toolbar"><button id="profile-start-btn" class="toolbar-btn primary">‚è∫ Start Recording</button><button id="profile-stop-btn" class="toolbar-btn" disabled>‚èπ Stop</button><button id="profile-clear-btn" class="toolbar-btn">üßπ Clear</button><select id="profile-type" class="toolbar-select"><option value="cpu">CPU Profile</option><option value="memory">Memory Snapshot</option><option value="timeline">Timeline</option></select></div><div class="profiler-metrics"><div class="metric-card-inline"><div class="metric-label">FPS</div><div class="metric-value" id="fps-value">60</div></div><div class="metric-card-inline"><div class="metric-label">CPU</div><div class="metric-value" id="cpu-value">0%</div></div><div class="metric-card-inline"><div class="metric-label">Memory</div><div class="metric-value" id="memory-value">0 MB</div></div><div class="metric-card-inline"><div class="metric-label">DOM Nodes</div><div class="metric-value" id="dom-nodes-value">0</div></div></div><canvas id="profiler-chart" style="width: 100%; height: 300px; background: #1e1e1e;"></canvas><div id="profiler-details" class="profiler-details"></div></div>`;
  }

  createWebSocketPanel() {
    return `<div class="devtools-tab-content" id="websocket-tab"><div class="panel-toolbar"><button id="ws-clear-btn" class="toolbar-btn">üßπ Clear</button><button id="ws-pause-btn" class="toolbar-btn">‚è∏Ô∏è Pause</button><input type="text" id="ws-filter" placeholder="Filter messages..." class="toolbar-input"></div><div class="ws-stats" style="display: flex; gap: 20px; padding: 10px; background: #2a2a2a; margin-bottom: 10px;"><div>üìä Total: <span id="ws-total">0</span></div><div>üì§ Sent: <span id="ws-sent">0</span></div><div>üì• Received: <span id="ws-received">0</span></div><div>üîå Status: <span id="ws-status">Disconnected</span></div></div><div id="ws-messages" class="ws-messages"></div><div class="ws-sender" style="margin-top: 10px; padding: 10px; background: #2a2a2a;"><h4 style="margin: 0 0 10px 0; color: #888;">Send Message</h4><textarea id="ws-send-input" placeholder='{"type": "test", "data": {...}}' style="width: 100%; height: 100px; background: #1e1e1e; color: #d4d4d4; border: 1px solid #3c3c3c; padding: 10px; font-family: monospace;"></textarea><button id="ws-send-btn" class="toolbar-btn primary" style="margin-top: 10px;">üì§ Send</button></div></div>`;
  }

  createTerminalPanel() {
    return `<div class="devtools-tab-content" id="terminal-tab"><div class="terminal-output" id="terminal-output"></div><div class="terminal-input-container"><span class="terminal-prompt">></span><input type="text" id="terminal-input" class="terminal-input" placeholder="Execute JavaScript..."></div><div class="terminal-help" style="padding: 10px; color: #666; font-size: 11px;"><strong>Available commands:</strong> $0 (selected element), clear, help, inspect(obj), copy(obj), $$ (querySelectorAll), document, window, localStorage, sessionStorage</div></div>`;
  }

  createLighthousePanel() {
    return `<div class="devtools-tab-content" id="lighthouse-tab"><div class="panel-toolbar"><button id="lighthouse-run-btn" class="toolbar-btn primary">üî¶ Run Audit</button><div class="checkbox-group"><label><input type="checkbox" checked> Performance</label><label><input type="checkbox" checked> Accessibility</label><label><input type="checkbox" checked> Best Practices</label><label><input type="checkbox" checked> SEO</label></div></div><div id="lighthouse-results" class="lighthouse-results"><p style="color: #666; padding: 20px; text-align: center;">Click "Run Audit" to analyze the dashboard</p></div></div>`;
  }

  createSnippetsPanel() {
    return `<div class="devtools-tab-content" id="snippets-tab"><div class="panel-split"><div class="panel-left" style="flex: 0 0 250px; border-right: 1px solid #3c3c3c;"><div class="panel-toolbar"><button id="snippet-new-btn" class="toolbar-btn">‚ûï New</button><button id="snippet-delete-btn" class="toolbar-btn">üóëÔ∏è Delete</button></div><div id="snippets-list" class="snippets-list"></div></div><div class="panel-right" style="flex: 1; padding: 10px;"><div class="panel-toolbar"><input type="text" id="snippet-name" placeholder="Snippet name..." class="toolbar-input"><button id="snippet-save-btn" class="toolbar-btn">üíæ Save</button><button id="snippet-run-btn" class="toolbar-btn primary">‚ñ∂Ô∏è Run</button></div><textarea id="snippet-editor" class="snippet-editor" placeholder="// Write JavaScript code here..."></textarea><div id="snippet-output" class="snippet-output"></div></div></div></div>`;
  }

  refreshDOMTree() {
    const tree = document.getElementById('dom-tree');
    if (!tree) return;
    const buildTree = (element, level = 0) => {
      const tagName = element.tagName?.toLowerCase() || '#text';
      const id = element.id ? `#${element.id}` : '';
      const classes = element.className ? `.${element.className.split(' ').join('.')}` : '';
      let html = `<div class="dom-node" data-level="${level}" style="padding-left: ${level * 20}px;"><span class="dom-tag">&lt;${tagName}${id}${classes}&gt;</span>`;
      if (element.children && element.children.length > 0) {
        html += `<div class="dom-children">`;
        Array.from(element.children).forEach(child => { html += buildTree(child, level + 1); });
        html += `</div>`;
      }
      html += `</div>`;
      return html;
    };
    tree.innerHTML = buildTree(document.body);
  }

  selectStorage(type) {
    const viewer = document.getElementById('storage-viewer');
    if (!viewer) return;
    switch (type) {
      case 'localStorage': this.displayStorage(localStorage, 'Local Storage'); break;
      case 'sessionStorage': this.displayStorage(sessionStorage, 'Session Storage'); break;
      case 'cookies': this.displayCookies(); break;
      case 'indexedDB': this.displayIndexedDB(); break;
      case 'cache': this.displayCacheStorage(); break;
    }
  }

  displayStorage(storage, title) {
    const viewer = document.getElementById('storage-viewer');
    if (!viewer) return;
    let html = `<h3 style="margin-top: 0;">${title}</h3><table class="storage-table"><thead><tr><th>Key</th><th>Value</th><th>Size</th></tr></thead><tbody>`;
    for (let i = 0; i < storage.length; i++) {
      const key = storage.key(i);
      const value = storage.getItem(key);
      const size = new Blob([value]).size;
      html += `<tr><td><code>${key}</code></td><td><code>${value.substring(0, 100)}${value.length > 100 ? '...' : ''}</code></td><td>${size} bytes</td></tr>`;
    }
    html += `</tbody></table>`;
    viewer.innerHTML = html;
  }

  displayCookies() {
    const viewer = document.getElementById('storage-viewer');
    if (!viewer) return;
    const cookies = document.cookie.split(';').map(c => {
      const [key, ...valueParts] = c.trim().split('=');
      return { key, value: valueParts.join('=') };
    });
    let html = `<h3 style="margin-top: 0;">Cookies</h3><table class="storage-table"><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody>`;
    cookies.forEach(cookie => { html += `<tr><td><code>${cookie.key}</code></td><td><code>${cookie.value}</code></td></tr>`; });
    html += `</tbody></table>`;
    viewer.innerHTML = html;
  }

  async displayIndexedDB() {
    const viewer = document.getElementById('storage-viewer');
    if (!viewer) return;
    const databases = await indexedDB.databases();
    let html = `<h3 style="margin-top: 0;">IndexedDB</h3><div class="indexeddb-list">`;
    if (databases.length === 0) { html += `<p style="color: #666;">No IndexedDB databases found</p>`; }
    else { databases.forEach(db => { html += `<div class="db-item"><strong>${db.name}</strong> (Version: ${db.version})</div>`; }); }
    html += `</div>`;
    viewer.innerHTML = html;
  }

  async displayCacheStorage() {
    const viewer = document.getElementById('storage-viewer');
    if (!viewer) return;
    const cacheNames = await caches.keys();
    let html = `<h3 style="margin-top: 0;">Cache Storage</h3><div class="cache-list">`;
    if (cacheNames.length === 0) { html += `<p style="color: #666;">No caches found</p>`; }
    else { for (const name of cacheNames) { const cache = await caches.open(name); const requests = await cache.keys(); html += `<div class="cache-item"><strong>${name}</strong> (${requests.length} entries)</div>`; } }
    html += `</div>`;
    viewer.innerHTML = html;
  }

  startProfiling() {
    console.log('üé¨ Starting profiler...');
    this.profilerActive = true;
    this.profilerStartTime = performance.now();
    this.monitorFPS();
    this.monitorMemory();
  }

  stopProfiling() {
    console.log('‚èπ Stopping profiler...');
    this.profilerActive = false;
    this.generateProfileReport();
  }

  monitorFPS() {
    if (!this.profilerActive) return;
    let lastTime = performance.now();
    let frames = 0;
    const countFrame = () => {
      frames++;
      const currentTime = performance.now();
      if (currentTime >= lastTime + 1000) {
        const fps = Math.round((frames * 1000) / (currentTime - lastTime));
        const fpsEl = document.getElementById('fps-value');
        if (fpsEl) fpsEl.textContent = fps;
        frames = 0;
        lastTime = currentTime;
      }
      if (this.profilerActive) { requestAnimationFrame(countFrame); }
    };
    requestAnimationFrame(countFrame);
  }

  monitorMemory() {
    if (!performance.memory) return;
    const updateMemory = () => {
      if (!this.profilerActive) return;
      const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
      const memEl = document.getElementById('memory-value');
      if (memEl) memEl.textContent = `${used} MB`;
      const domNodes = document.getElementsByTagName('*').length;
      const domEl = document.getElementById('dom-nodes-value');
      if (domEl) domEl.textContent = domNodes;
      setTimeout(updateMemory, 1000);
    };
    updateMemory();
  }

  generateProfileReport() {
    const duration = (performance.now() - this.profilerStartTime) / 1000;
    const details = document.getElementById('profiler-details');
    if (!details) return;
    details.innerHTML = `<div class="profile-report"><h3>Profile Report</h3><p><strong>Duration:</strong> ${duration.toFixed(2)}s</p><p><strong>Average FPS:</strong> ${document.getElementById('fps-value')?.textContent || 'N/A'}</p><p><strong>Memory Used:</strong> ${document.getElementById('memory-value')?.textContent || 'N/A'}</p><p><strong>DOM Nodes:</strong> ${document.getElementById('dom-nodes-value')?.textContent || 'N/A'}</p></div>`;
  }

  executeTerminalCommand(command) {
    const output = document.getElementById('terminal-output');
    if (!output) return;
    this.terminalHistory.push(command);
    output.innerHTML += `<div class="terminal-line"><span class="terminal-prompt">></span> ${command}</div>`;
    let result;
    try {
      if (command === 'clear') { output.innerHTML = ''; return; }
      if (command === 'help') { result = this.getTerminalHelp(); }
      else { result = eval(command); }
      const resultStr = typeof result === 'object' ? JSON.stringify(result, null, 2) : String(result);
      output.innerHTML += `<div class="terminal-result">${resultStr}</div>`;
    } catch (error) {
      output.innerHTML += `<div class="terminal-error">Error: ${error.message}</div>`;
    }
    output.scrollTop = output.scrollHeight;
  }

  getTerminalHelp() {
    return `Available Commands:\n  - clear: Clear terminal\n  - help: Show this help\n  - $0: Selected DOM element\n  - $$(selector): querySelectorAll\n  - inspect(obj): Pretty print object\n  - copy(obj): Copy to clipboard\n  - Any valid JavaScript expression`;
  }

  async runLighthouseAudit() {
    const results = document.getElementById('lighthouse-results');
    if (!results) return;
    results.innerHTML = '<div class="audit-loading">üî¶ Running audits...</div>';
    await new Promise(resolve => setTimeout(resolve, 2000));
    const scores = {
      performance: this.auditPerformance(),
      accessibility: this.auditAccessibility(),
      bestPractices: this.auditBestPractices(),
      seo: this.auditSEO()
    };
    this.displayLighthouseResults(scores);
  }

  auditPerformance() {
    const fcp = performance.getEntriesByType('paint').find(e => e.name === 'first-contentful-paint')?.startTime || 0;
    let score = 100;
    if (fcp > 3000) score -= 30;
    else if (fcp > 1800) score -= 10;
    return { score, metrics: { fcp: fcp.toFixed(0) } };
  }

  auditAccessibility() {
    let score = 100;
    const issues = [];
    const imagesWithoutAlt = document.querySelectorAll('img:not([alt])').length;
    if (imagesWithoutAlt > 0) { score -= 20; issues.push(`${imagesWithoutAlt} images missing alt text`); }
    const buttonsWithoutLabels = document.querySelectorAll('button:not([aria-label]):not([aria-labelledby])').length;
    if (buttonsWithoutLabels > 0) { score -= 10; issues.push(`${buttonsWithoutLabels} buttons missing ARIA labels`); }
    return { score: Math.max(0, score), issues };
  }

  auditBestPractices() {
    let score = 100;
    const issues = [];
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') { score -= 20; issues.push('Not using HTTPS'); }
    if (this.base.logs.filter(l => l.type === 'error').length > 0) { score -= 10; issues.push('Console errors detected'); }
    return { score: Math.max(0, score), issues };
  }

  auditSEO() {
    let score = 100;
    const issues = [];
    if (!document.querySelector('meta[name="description"]')) { score -= 20; issues.push('Missing meta description'); }
    if (!document.title || document.title.length < 10) { score -= 20; issues.push('Page title too short or missing'); }
    if (document.querySelectorAll('h1').length === 0) { score -= 10; issues.push('Missing H1 tag'); }
    return { score: Math.max(0, score), issues };
  }

  displayLighthouseResults(scores) {
    const results = document.getElementById('lighthouse-results');
    if (!results) return;
    const getScoreColor = (score) => {
      if (score >= 90) return '#4CAF50';
      if (score >= 50) return '#FF9800';
      return '#F44336';
    };
    let html = '<div class="lighthouse-scores">';
    Object.entries(scores).forEach(([category, data]) => {
      const color = getScoreColor(data.score);
      html += `<div class="score-card"><div class="score-circle" style="border-color: ${color};"><div class="score-value" style="color: ${color};">${data.score}</div></div><div class="score-label">${category.replace(/([A-Z])/g, ' $1').trim()}</div>${data.issues ? `<div class="score-issues">${data.issues.map(issue => `<div>‚ö†Ô∏è ${issue}</div>`).join('')}</div>` : ''}</div>`;
    });
    html += '</div>';
    results.innerHTML = html;
  }

  loadSnippets() {
    const saved = localStorage.getItem('devtools-snippets');
    return saved ? JSON.parse(saved) : [
      { name: 'Example: Log All Links', code: 'document.querySelectorAll("a").forEach(a => console.log(a.href));' },
      { name: 'Example: Count Elements', code: 'console.log("Total elements:", document.getElementsByTagName("*").length);' }
    ];
  }

  saveSnippets() {
    localStorage.setItem('devtools-snippets', JSON.stringify(this.snippets));
    this.refreshSnippetsList();
  }

  refreshSnippetsList() {
    const list = document.getElementById('snippets-list');
    if (!list) return;
    list.innerHTML = this.snippets.map((snippet, index) => `<div class="snippet-item ${index === this.selectedSnippet ? 'active' : ''}" onclick="window.advancedDevTools.selectSnippet(${index})">‚úÇÔ∏è ${snippet.name}</div>`).join('');
  }

  selectSnippet(index) {
    this.selectedSnippet = index;
    const snippet = this.snippets[index];
    document.getElementById('snippet-name').value = snippet.name;
    document.getElementById('snippet-editor').value = snippet.code;
    this.refreshSnippetsList();
  }

  runSnippet() {
    const code = document.getElementById('snippet-editor').value;
    const output = document.getElementById('snippet-output');
    try {
      const result = eval(code);
      output.innerHTML = `<div class="success">‚úÖ Executed successfully${result !== undefined ? `\nResult: ${JSON.stringify(result, null, 2)}` : ''}</div>`;
    } catch (error) {
      output.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
    }
  }

  attachEventListeners() {
    document.getElementById('refresh-dom-btn')?.addEventListener('click', () => this.refreshDOMTree());
    document.getElementById('storage-clear-btn')?.addEventListener('click', () => {
      if (confirm('Clear all storage?')) { localStorage.clear(); sessionStorage.clear(); this.base.log('success', 'Storage cleared'); }
    });
    document.getElementById('profile-start-btn')?.addEventListener('click', () => this.startProfiling());
    document.getElementById('profile-stop-btn')?.addEventListener('click', () => this.stopProfiling());
    document.getElementById('terminal-input')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { this.executeTerminalCommand(e.target.value); e.target.value = ''; }
    });
    document.getElementById('lighthouse-run-btn')?.addEventListener('click', () => this.runLighthouseAudit());
    document.getElementById('snippet-run-btn')?.addEventListener('click', () => this.runSnippet());
    document.getElementById('snippet-save-btn')?.addEventListener('click', () => {
      const name = document.getElementById('snippet-name').value;
      const code = document.getElementById('snippet-editor').value;
      if (this.selectedSnippet !== undefined) { this.snippets[this.selectedSnippet] = { name, code }; }
      else { this.snippets.push({ name, code }); }
      this.saveSnippets();
      this.base.log('success', `Snippet "${name}" saved`);
    });
  }

  setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') { e.preventDefault(); this.switchToPanel('elements'); }
      if ((e.ctrlKey || e.metaKey) && e.key === 'p') { e.preventDefault(); this.switchToPanel('profiler'); }
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); this.switchToPanel('terminal'); document.getElementById('terminal-input')?.focus(); }
    });
  }

  switchToPanel(panelId) {
    this.base.switchTab(panelId);
    switch (panelId) {
      case 'elements': this.refreshDOMTree(); break;
      case 'snippets': this.refreshSnippetsList(); break;
    }
  }

  startPerformanceMonitoring() {
    setInterval(() => {
      if (!this.profilerActive) return;
      const cpuEl = document.getElementById('cpu-value');
      if (cpuEl) { cpuEl.textContent = '~5%'; }
    }, 1000);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    if (window.devtools) {
      window.advancedDevTools = new AdvancedDevTools(window.devtools);
    }
  }, 1500);
});

  </script>

  <style>
    /* Advanced DevTools Styling */

    /* Panel Split Layout */
    .panel-split {
      display: flex;
      height: calc(100vh - 150px);
      overflow: hidden;
    }

    .panel-left, .panel-center, .panel-right {
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Toolbar */
    .panel-toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #2a2a2a;
      border-bottom: 1px solid #3c3c3c;
      flex-wrap: wrap;
    }

    .toolbar-btn {
      padding: 6px 12px;
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .toolbar-btn:hover {
      background: #4c4c4c;
      border-color: #666;
    }

    .toolbar-btn.primary {
      background: #0d7dcd;
      border-color: #0d7dcd;
    }

    .toolbar-btn.primary:hover {
      background: #1a8cdd;
    }

    .toolbar-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .toolbar-input {
      padding: 6px 12px;
      background: #1e1e1e;
      border: 1px solid #3c3c3c;
      color: #d4d4d4;
      border-radius: 4px;
      font-size: 12px;
      min-width: 200px;
    }

    .toolbar-input:focus {
      outline: none;
      border-color: #0d7dcd;
    }

    .toolbar-select {
      padding: 6px 12px;
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    /* Elements Panel */
    .dom-tree {
      padding: 10px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.6;
    }

    .dom-node {
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 3px;
      transition: background 0.2s;
    }

    .dom-node:hover {
      background: #2a2a2a;
    }

    .dom-tag {
      color: #569cd6;
    }

    .dom-children {
      margin-left: 20px;
    }

    .tabs-mini {
      display: flex;
      gap: 5px;
      padding: 10px;
      background: #1e1e1e;
      border-bottom: 1px solid #3c3c3c;
    }

    .tab-mini {
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 12px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .tab-mini:hover {
      color: #d4d4d4;
      background: #2a2a2a;
    }

    .tab-mini.active {
      color: #d4d4d4;
      background: #3c3c3c;
    }

    #element-details {
      padding: 15px;
      font-size: 12px;
    }

    .element-info h4 {
      margin: 0 0 15px 0;
      color: #d4d4d4;
      font-size: 14px;
    }

    .info-section {
      margin-bottom: 10px;
      padding: 8px;
      background: #2a2a2a;
      border-radius: 4px;
      color: #888;
    }

    .info-section strong {
      color: #d4d4d4;
      margin-right: 10px;
    }

    /* Sources Panel */
    .sources-tree {
      padding: 10px;
      font-size: 12px;
    }

    .source-viewer {
      margin: 0;
      padding: 15px;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.6;
      overflow-x: auto;
      white-space: pre;
    }

    #breakpoints-list, #call-stack, #scope-viewer {
      font-size: 12px;
      color: #888;
    }

    /* Storage Panel */
    .storage-tree {
      padding: 10px;
    }

    .storage-section {
      margin-bottom: 10px;
    }

    .storage-header {
      padding: 8px 12px;
      background: #2a2a2a;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      color: #d4d4d4;
      transition: background 0.2s;
    }

    .storage-header:hover {
      background: #3c3c3c;
    }

    .storage-viewer {
      font-size: 12px;
    }

    .storage-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .storage-table thead {
      background: #2a2a2a;
      position: sticky;
      top: 0;
    }

    .storage-table th {
      padding: 10px;
      text-align: left;
      color: #d4d4d4;
      font-weight: 600;
      border-bottom: 1px solid #3c3c3c;
    }

    .storage-table td {
      padding: 10px;
      border-bottom: 1px solid #2a2a2a;
      color: #888;
    }

    .storage-table tr:hover {
      background: #2a2a2a;
    }

    .storage-table code {
      background: #1e1e1e;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-family: 'Monaco', 'Menlo', monospace;
    }

    /* Profiler Panel */
    .profiler-metrics {
      display: flex;
      gap: 15px;
      padding: 15px;
      background: #2a2a2a;
      border-bottom: 1px solid #3c3c3c;
      flex-wrap: wrap;
    }

    .metric-card-inline {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      background: #1e1e1e;
      border-radius: 6px;
      border-left: 3px solid #4CAF50;
    }

    .metric-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #4CAF50;
      font-family: monospace;
    }

    #profiler-chart {
      margin: 15px;
      border-radius: 8px;
    }

    .profiler-details {
      padding: 15px;
      font-size: 12px;
    }

    .profile-report {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 6px;
    }

    .profile-report h3 {
      margin: 0 0 15px 0;
      color: #d4d4d4;
    }

    .profile-report p {
      margin: 8px 0;
      color: #888;
    }

    .profile-report strong {
      color: #d4d4d4;
    }

    /* WebSocket Panel */
    .ws-stats {
      font-size: 12px;
      color: #888;
    }

    .ws-stats span {
      color: #d4d4d4;
      font-weight: 600;
    }

    .ws-messages {
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #1e1e1e;
      border-radius: 6px;
      margin: 10px;
      font-size: 12px;
    }

    .ws-sender {
      border-top: 1px solid #3c3c3c;
    }

    .ws-sender h4 {
      margin: 0 0 10px 0;
      color: #888;
      font-size: 12px;
    }

    /* Terminal Panel */
    .terminal-output {
      height: calc(100vh - 250px);
      overflow-y: auto;
      padding: 15px;
      background: #000;
      color: #0f0;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .terminal-input-container {
      display: flex;
      align-items: center;
      padding: 10px;
      background: #000;
      border-top: 1px solid #333;
    }

    .terminal-prompt {
      color: #0f0;
      margin-right: 10px;
      font-family: monospace;
      font-weight: bold;
    }

    .terminal-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #0f0;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      outline: none;
    }

    .terminal-line {
      margin-bottom: 5px;
    }

    .terminal-result {
      color: #888;
      margin-left: 20px;
      margin-bottom: 10px;
    }

    .terminal-error {
      color: #f44;
      margin-left: 20px;
      margin-bottom: 10px;
    }

    .terminal-help {
      background: #1e1e1e;
      border-top: 1px solid #3c3c3c;
    }

    /* Lighthouse Panel */
    .lighthouse-results {
      padding: 20px;
    }

    .lighthouse-scores {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .score-card {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .score-circle {
      width: 120px;
      height: 120px;
      margin: 0 auto 15px;
      border: 8px solid #4CAF50;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .score-value {
      font-size: 36px;
      font-weight: 700;
      color: #4CAF50;
    }

    .score-label {
      font-size: 14px;
      color: #d4d4d4;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: capitalize;
    }

    .score-issues {
      margin-top: 15px;
      text-align: left;
      font-size: 11px;
      color: #888;
      padding: 10px;
      background: #1e1e1e;
      border-radius: 4px;
    }

    .score-issues div {
      margin-bottom: 5px;
    }

    .audit-loading {
      text-align: center;
      padding: 40px;
      font-size: 16px;
      color: #888;
    }

    .checkbox-group {
      display: flex;
      gap: 15px;
      margin-left: 20px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #d4d4d4;
      font-size: 12px;
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      cursor: pointer;
    }

    /* Snippets Panel */
    .snippets-list {
      padding: 10px;
    }

    .snippet-item {
      padding: 10px;
      margin-bottom: 5px;
      background: #2a2a2a;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      color: #d4d4d4;
      transition: background 0.2s;
    }

    .snippet-item:hover {
      background: #3c3c3c;
    }

    .snippet-item.active {
      background: #0d7dcd;
      color: #fff;
    }

    .snippet-editor {
      width: 100%;
      height: 300px;
      background: #1e1e1e;
      color: #d4d4d4;
      border: 1px solid #3c3c3c;
      padding: 15px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.6;
      resize: vertical;
      border-radius: 4px;
      margin-top: 10px;
    }

    .snippet-editor:focus {
      outline: none;
      border-color: #0d7dcd;
    }

    .snippet-output {
      margin-top: 15px;
      padding: 15px;
      background: #1e1e1e;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      min-height: 100px;
    }

    .snippet-output .success {
      color: #4CAF50;
    }

    .snippet-output .error {
      color: #F44336;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .panel-split {
        flex-direction: column;
      }

      .panel-left, .panel-center, .panel-right {
        flex: 1 !important;
        border: none !important;
        border-bottom: 1px solid #3c3c3c !important;
      }

      .profiler-metrics {
        flex-direction: column;
      }

      .lighthouse-scores {
        grid-template-columns: 1fr;
      }
    }

    /* Scrollbar styling */
    .panel-left::-webkit-scrollbar,
    .panel-center::-webkit-scrollbar,
    .panel-right::-webkit-scrollbar,
    .dom-tree::-webkit-scrollbar,
    .ws-messages::-webkit-scrollbar,
    .terminal-output::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .panel-left::-webkit-scrollbar-track,
    .panel-center::-webkit-scrollbar-track,
    .panel-right::-webkit-scrollbar-track,
    .dom-tree::-webkit-scrollbar-track,
    .ws-messages::-webkit-scrollbar-track,
    .terminal-output::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    .panel-left::-webkit-scrollbar-thumb,
    .panel-center::-webkit-scrollbar-thumb,
    .panel-right::-webkit-scrollbar-thumb,
    .dom-tree::-webkit-scrollbar-thumb,
    .ws-messages::-webkit-scrollbar-thumb,
    .terminal-output::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }

    .panel-left::-webkit-scrollbar-thumb:hover,
    .panel-center::-webkit-scrollbar-thumb:hover,
    .panel-right::-webkit-scrollbar-thumb:hover,
    .dom-tree::-webkit-scrollbar-thumb:hover,
    .ws-messages::-webkit-scrollbar-thumb:hover,
    .terminal-output::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
  </style>
</body>
</html>
