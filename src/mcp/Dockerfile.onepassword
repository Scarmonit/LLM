# 1Password MCP Server - Docker Image
# Secure secret management and retrieval

FROM node:20-alpine

# Install 1Password CLI
RUN apk add --no-cache \
    curl \
    gnupg \
    && rm -rf /var/cache/apk/*

# Download and install 1Password CLI (op)
RUN curl -sSfO https://cache.agilebits.com/dist/1P/op2/pkg/v2.24.0/op_linux_amd64_v2.24.0.zip \
    && unzip op_linux_amd64_v2.24.0.zip \
    && mv op /usr/local/bin/ \
    && rm op_linux_amd64_v2.24.0.zip \
    && chmod +x /usr/local/bin/op

# Set working directory
WORKDIR /app

# Create package.json
RUN echo '{"name":"onepassword-mcp","version":"1.0.0","type":"module","dependencies":{"@modelcontextprotocol/sdk":"^1.0.4"}}' > package.json

# Install dependencies
RUN npm install --omit=dev

# Create 1Password MCP server script
RUN cat > onepassword-mcp-server.js << 'EOF'
#!/usr/bin/env node
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { CallToolRequestSchema, ListToolsRequestSchema } from '@modelcontextprotocol/sdk/types.js';
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

class OnePasswordServer {
  constructor() {
    this.server = new Server(
      { name: 'onepassword-mcp', version: '1.0.0' },
      { capabilities: { tools: {} } }
    );
    this.setupHandlers();
  }

  setupHandlers() {
    this.server.setRequestHandler(ListToolsRequestSchema, async () => ({
      tools: [
        {
          name: 'op_get_item',
          description: 'Get item from 1Password vault',
          inputSchema: {
            type: 'object',
            properties: {
              item: { type: 'string', description: 'Item name or UUID' },
              vault: { type: 'string', description: 'Vault name (optional)' }
            },
            required: ['item']
          }
        },
        {
          name: 'op_list_items',
          description: 'List items in 1Password vault',
          inputSchema: {
            type: 'object',
            properties: {
              vault: { type: 'string', description: 'Vault name (optional)' }
            }
          }
        }
      ]
    }));

    this.server.setRequestHandler(CallToolRequestSchema, async (request) => {
      try {
        const serviceToken = process.env.OP_SERVICE_ACCOUNT_TOKEN;
        if (!serviceToken) {
          throw new Error('OP_SERVICE_ACCOUNT_TOKEN not set');
        }

        let cmd;
        switch (request.params.name) {
          case 'op_get_item':
            cmd = `op item get "${request.params.arguments.item}"`;
            if (request.params.arguments.vault) {
              cmd += ` --vault "${request.params.arguments.vault}"`;
            }
            break;
          case 'op_list_items':
            cmd = 'op item list';
            if (request.params.arguments.vault) {
              cmd += ` --vault "${request.params.arguments.vault}"`;
            }
            break;
          default:
            throw new Error(`Unknown tool: ${request.params.name}`);
        }

        const { stdout } = await execAsync(cmd, {
          env: { ...process.env, OP_SERVICE_ACCOUNT_TOKEN: serviceToken }
        });
        return { content: [{ type: 'text', text: stdout }] };
      } catch (error) {
        return { content: [{ type: 'text', text: `Error: ${error.message}` }], isError: true };
      }
    });
  }

  async run() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
  }
}

const server = new OnePasswordServer();
server.run().catch(console.error);
EOF

RUN chmod +x onepassword-mcp-server.js

# Set environment variables
ENV NODE_ENV=production

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD node -e "process.exit(0)"

# Run the 1Password MCP server
CMD ["node", "onepassword-mcp-server.js"]
