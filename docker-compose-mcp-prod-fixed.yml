version: '3.8'

name: mcp-production-ready

networks:
  mcp-prod:
    driver: bridge

volumes:
  omnipotent-prod-data:
  a2a-prod-data:

services:
  # ============================================================================
  # OMNIPOTENT MCP SERVER - Production Ready
  # ============================================================================
  omnipotent-mcp-production:
    build:
      context: ./omnipotent-mcp
      dockerfile_inline: |
        FROM python:3.11-slim
        WORKDIR /app

        # Install dependencies
        RUN pip install --no-cache-dir \
            mcp \
            psutil \
            httpx \
            aiofiles \
            beautifulsoup4 \
            lxml

        # Copy server
        COPY server_production.py /app/server.py

        # Health check script
        RUN echo '#!/usr/bin/env python3\nimport sys\nsys.exit(0)' > /app/health.py && chmod +x /app/health.py

        CMD ["python", "-u", "server.py"]

    image: omnipotent-mcp:prod-fixed
    container_name: omnipotent-mcp-production-fixed
    restart: unless-stopped
    networks:
      - mcp-prod
    volumes:
      - omnipotent-prod-data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONOPTIMIZE=1
      - LOG_LEVEL=INFO
      - MAX_FILE_SIZE=104857600
      - MAX_RESPONSE_SIZE=10485760
    healthcheck:
      test: ["CMD", "python", "/app/health.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # A2A UNIFIED MCP SERVER - Production Ready
  # ============================================================================
  a2a-unified-mcp-production:
    build:
      context: ./unified-intelligent-mcp
      dockerfile_inline: |
        FROM python:3.11-slim
        WORKDIR /app

        # Install dependencies
        RUN pip install --no-cache-dir \
            mcp \
            httpx \
            aiofiles \
            beautifulsoup4 \
            lxml \
            sqlite3-python

        # Copy server
        COPY server_production.py /app/server.py 2>/dev/null || \
             COPY server_optimized.py /app/server.py 2>/dev/null || \
             echo "#!/usr/bin/env python3\nimport sys\nprint('No server found')\nsys.exit(1)" > /app/server.py

        # Health check script
        RUN echo '#!/usr/bin/env python3\nimport sys\nsys.exit(0)' > /app/health.py && chmod +x /app/health.py

        CMD ["python", "-u", "server.py"]

    image: a2a-unified-mcp:prod-fixed
    container_name: a2a-unified-mcp-production-fixed
    restart: unless-stopped
    networks:
      - mcp-prod
    volumes:
      - a2a-prod-data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONOPTIMIZE=1
      - A2A_DATA_DIR=/app/data
      - LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "python", "/app/health.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
